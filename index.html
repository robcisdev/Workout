<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Timer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        workout: '#10B981',
                        rest: '#F59E0B'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(93, 92, 222, 0.3); }
            50% { box-shadow: 0 0 40px rgba(93, 92, 222, 0.6); }
        }
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        @keyframes slide-in {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in {
            animation: slide-in 0.3s ease-out;
        }
        .timer-display {
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }
        input:focus, textarea:focus, button:focus {
            outline: none;
            ring: 2px;
            ring-color: rgba(93, 92, 222, 0.5);
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 overflow-hidden h-screen">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="w-full md:w-80 lg:w-96 bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 flex flex-col transition-all duration-300">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h1 class="text-2xl font-bold text-primary flex items-center gap-2">
                    <i class="fas fa-dumbbell"></i>
                    Workout Timer Pro
                </h1>
            </div>

            <!-- Workout Mode Selector -->
            <div class="p-4 bg-gradient-to-r from-primary/10 to-primary/5 border-b border-gray-200 dark:border-gray-700">
                <label class="block text-sm font-medium mb-2">Workout Mode</label>
                <select id="workoutMode" class="w-full px-3 py-2 text-base bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option value="rounds">Circuit Rounds</option>
                    <option value="shuffle">Shuffle Rounds</option>
                    <option value="series">Exercise by Exercise</option>
                </select>
                <p class="mt-1 text-xs text-gray-600 dark:text-gray-400" id="modeDescription">
                    Complete all exercises, then repeat the round
                </p>
            </div>

            <!-- Progress Bar -->
            <div class="p-4 bg-gradient-to-r from-primary/10 to-primary/5">
                <div class="flex justify-between text-sm mb-2">
                    <span class="font-medium">Overall Progress</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-primary to-purple-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
                    <span id="currentExerciseInfo">Ready to start</span>
                </div>
            </div>

            <!-- Exercise List -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold">Exercises</h2>
                    <button id="addExerciseBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5">
                        <i class="fas fa-plus"></i>
                        Add
                    </button>
                </div>
                <div id="exerciseList" class="space-y-2">
                    <!-- Exercises will be added here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
                <div class="grid grid-cols-2 gap-2">
                    <button id="saveBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i>
                        Save
                    </button>
                    <button id="loadBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 px-4 py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-folder-open"></i>
                        Load
                    </button>
                </div>
                <button id="editModeBtn" class="w-full bg-primary/10 hover:bg-primary/20 text-primary px-4 py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-edit"></i>
                    Edit Workout
                </button>
                <button id="closeSidebarBtn" class="w-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2 border border-gray-300 dark:border-gray-600">
                    <i class="fas fa-times"></i>
                    Close Menu
                </button>
            </div>
        </div>

        <!-- Main Timer Area -->
        <div id="timerArea" class="flex-1 flex flex-col items-center justify-center p-8 relative">
            <!-- Toggle Sidebar Button -->
            <button id="toggleSidebar" class="absolute top-4 left-4 bg-primary hover:bg-primary/90 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg z-10 transition-all">
                <i class="fas fa-bars"></i>
            </button>

            <!-- Progress Bar in Full Screen -->
            <div id="fullscreenProgress" class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-white/90 dark:from-[#181818]/90 to-transparent backdrop-blur-sm">
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="font-medium">Overall Progress</span>
                        <span id="progressTextFS">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
                        <div id="progressBarFS" class="bg-gradient-to-r from-primary to-purple-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600 dark:text-gray-400">
                        <span id="currentExerciseInfoFS">Ready to start</span>
                    </div>
                </div>
            </div>

            <!-- Timer Display -->
            <div class="text-center max-w-2xl w-full mt-16">
                <div id="exerciseTitle" class="text-3xl md:text-5xl font-bold mb-8 slide-in">
                    Ready to Start
                </div>

                <div id="timerDisplay" class="timer-display text-8xl md:text-9xl font-bold mb-8 transition-colors duration-300">
                    00:45
                </div>

                <div id="phaseIndicator" class="text-2xl md:text-3xl font-semibold mb-8 uppercase tracking-wider">
                    <span class="px-6 py-3 rounded-full bg-gray-200 dark:bg-gray-700">
                        Get Ready
                    </span>
                </div>

                <!-- Up Next Display -->
                <div id="upNextContainer" class="mb-8 text-center">
                    <div class="text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Up Next</div>
                    <div id="upNextExercise" class="text-xl md:text-2xl font-semibold text-primary">
                        --
                    </div>
                </div>

                <!-- Timer Controls -->
                <div class="flex gap-4 justify-center items-center mb-8">
                    <button id="prevBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 w-14 h-14 rounded-full transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-step-backward text-xl"></i>
                    </button>

                    <button id="playPauseBtn" class="bg-primary hover:bg-primary/90 text-white w-20 h-20 rounded-full transition-all pulse-glow flex items-center justify-center shadow-xl">
                        <i class="fas fa-play text-3xl ml-1"></i>
                    </button>

                    <button id="nextBtn" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 w-14 h-14 rounded-full transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-step-forward text-xl"></i>
                    </button>
                </div>

                <button id="resetBtn" class="bg-red-500/10 hover:bg-red-500/20 text-red-600 dark:text-red-400 px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-redo-alt mr-2"></i>
                    Reset Workout
                </button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Exercise Modal -->
    <div id="exerciseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full mx-4 slide-in">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 id="modalTitle" class="text-2xl font-bold">Add Exercise</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Exercise Name</label>
                    <input type="text" id="exerciseName" class="w-full px-4 py-3 text-base bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g., Push-ups">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">Workout (sec)</label>
                        <input type="number" id="workoutDuration" class="w-full px-4 py-3 text-base bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="45">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Rest (sec)</label>
                        <input type="number" id="restDuration" class="w-full px-4 py-3 text-base bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="105">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Series (Repetitions)</label>
                    <input type="number" id="exerciseSeries" class="w-full px-4 py-3 text-base bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" value="3" min="1">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How many times to repeat this exercise</p>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 flex gap-3">
                <button id="cancelExerciseBtn" class="flex-1 px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button id="saveExerciseBtn" class="flex-1 px-6 py-3 bg-primary text-white hover:bg-primary/90 rounded-lg font-medium transition-colors">
                    Save
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // State
        let exercises = [];
        let currentExerciseIndex = 0;
        let currentPhase = 'workout'; // 'workout' or 'rest'
        let timeRemaining = 45;
        let isRunning = false;
        let timerInterval = null;
        let editingIndex = -1;
        let totalTimeElapsed = 0;
        let workoutMode = 'rounds'; // 'rounds', 'shuffle', or 'series'
        let currentRound = 1;
        let currentSeries = 1;
        let workoutSequence = []; // The order of exercises for current workout
        let shuffledOrder = []; // Stores shuffled order for shuffle mode

        // DOM Elements
        const exerciseList = document.getElementById('exerciseList');
        const timerDisplay = document.getElementById('timerDisplay');
        const exerciseTitle = document.getElementById('exerciseTitle');
        const phaseIndicator = document.getElementById('phaseIndicator');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentExerciseInfo = document.getElementById('currentExerciseInfo');
        const progressBarFS = document.getElementById('progressBarFS');
        const progressTextFS = document.getElementById('progressTextFS');
        const currentExerciseInfoFS = document.getElementById('currentExerciseInfoFS');
        const addExerciseBtn = document.getElementById('addExerciseBtn');
        const exerciseModal = document.getElementById('exerciseModal');
        const modalTitle = document.getElementById('modalTitle');
        const exerciseName = document.getElementById('exerciseName');
        const workoutDuration = document.getElementById('workoutDuration');
        const restDuration = document.getElementById('restDuration');
        const exerciseSeries = document.getElementById('exerciseSeries');
        const saveExerciseBtn = document.getElementById('saveExerciseBtn');
        const cancelExerciseBtn = document.getElementById('cancelExerciseBtn');
        const saveBtn = document.getElementById('saveBtn');
        const loadBtn = document.getElementById('loadBtn');
        const editModeBtn = document.getElementById('editModeBtn');
        const toggleSidebar = document.getElementById('toggleSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const sidebar = document.getElementById('sidebar');
        const timerArea = document.getElementById('timerArea');
        const workoutModeSelect = document.getElementById('workoutMode');
        const modeDescription = document.getElementById('modeDescription');
        const upNextExercise = document.getElementById('upNextExercise');

        // Audio Context for beep sounds
        let audioContext = null;
        let hasPlayedBeep = false;

        // Initialize Audio Context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play beep sound
        function playBeep(frequency = 800, duration = 0.1) {
            initAudioContext();

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // Initialize
        function init() {
            addExercise('Jumping Jacks', 45, 105, 3);
            addExercise('Push-ups', 45, 105, 3);
            addExercise('Squats', 45, 105, 3);
            buildWorkoutSequence();
            renderExercises();
            updateDisplay();
        }

        // Add Exercise
        function addExercise(name, workoutTime = 45, restTime = 105, series = 3) {
            exercises.push({
                name: name,
                workoutTime: workoutTime,
                restTime: restTime,
                series: series
            });
        }

        // Build workout sequence based on mode
        function buildWorkoutSequence() {
            workoutSequence = [];

            if (workoutMode === 'rounds' || workoutMode === 'shuffle') {
                // Get max series among all exercises
                const maxSeries = Math.max(...exercises.map(ex => ex.series), 1);

                for (let round = 1; round <= maxSeries; round++) {
                    let roundExercises = [];

                    exercises.forEach((ex, idx) => {
                        if (round <= ex.series) {
                            roundExercises.push({ exerciseIndex: idx, round: round, series: ex.series });
                        }
                    });

                    // Shuffle for shuffle mode
                    if (workoutMode === 'shuffle' && roundExercises.length > 0) {
                        roundExercises = shuffleArray([...roundExercises]);
                    }

                    workoutSequence.push(...roundExercises);
                }
            } else if (workoutMode === 'series') {
                // Exercise by exercise mode
                exercises.forEach((ex, idx) => {
                    for (let s = 1; s <= ex.series; s++) {
                        workoutSequence.push({ exerciseIndex: idx, round: s, series: ex.series });
                    }
                });
            }
        }

        // Shuffle array helper
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Render Exercises
        function renderExercises() {
            exerciseList.innerHTML = '';
            exercises.forEach((exercise, index) => {
                const currentSeqItem = workoutSequence[currentExerciseIndex];
                const isActive = currentSeqItem && currentSeqItem.exerciseIndex === index;

                const div = document.createElement('div');
                div.className = `bg-white dark:bg-gray-800 rounded-lg p-4 border-2 transition-all ${
                    isActive ? 'border-primary shadow-lg' : 'border-gray-200 dark:border-gray-700'
                }`;
                div.innerHTML = `
                    <div class="flex justify-between items-start gap-3">
                        <div class="flex flex-col gap-1 reorder-btns hidden">
                            <button class="move-up-btn text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 w-8 h-8 rounded transition-colors flex items-center justify-center ${index === 0 ? 'opacity-30 cursor-not-allowed' : ''}" data-index="${index}" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="move-down-btn text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 w-8 h-8 rounded transition-colors flex items-center justify-center ${index === exercises.length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" data-index="${index}" ${index === exercises.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-base mb-1">${exercise.name}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400 flex gap-3 flex-wrap">
                                <span><i class="fas fa-dumbbell text-workout"></i> ${exercise.workoutTime}s</span>
                                <span><i class="fas fa-clock text-rest"></i> ${exercise.restTime}s</span>
                                <span><i class="fas fa-repeat text-primary"></i> ${exercise.series}x</span>
                            </div>
                        </div>
                        <div class="flex gap-2" id="actions-${index}">
                            <button class="edit-btn text-primary hover:bg-primary/10 w-8 h-8 rounded-lg transition-colors hidden" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:bg-red-500/10 w-8 h-8 rounded-lg transition-colors hidden" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                exerciseList.appendChild(div);
            });

            // Add event listeners for edit/delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(parseInt(btn.dataset.index));
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showDeleteConfirm(parseInt(btn.dataset.index));
                });
            });

            // Add event listeners for reorder buttons
            document.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    if (index > 0) {
                        moveExercise(index, index - 1);
                    }
                });
            });

            document.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    if (index < exercises.length - 1) {
                        moveExercise(index, index + 1);
                    }
                });
            });
        }

        // Format Time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Get next exercise (skip rest phases)
        function getNextExercise() {
            if (workoutSequence.length === 0) return null;

            // If currently in workout phase, look for next workout phase
            let searchIndex = currentExerciseIndex;

            if (currentPhase === 'workout') {
                // Move to next item in sequence
                searchIndex++;
            } else {
                // Currently in rest, next will be workout at current index + 1
                searchIndex++;
            }

            // Find the next workout phase
            if (searchIndex < workoutSequence.length) {
                const nextSeqItem = workoutSequence[searchIndex];
                const nextExercise = exercises[nextSeqItem.exerciseIndex];
                return {
                    name: nextExercise.name,
                    round: nextSeqItem.round,
                    series: nextSeqItem.series
                };
            }

            return null; // No more exercises
        }

        // Update Display
        function updateDisplay() {
            if (exercises.length === 0 || workoutSequence.length === 0) {
                timerDisplay.textContent = '00:00';
                exerciseTitle.textContent = 'No exercises added';
                phaseIndicator.innerHTML = '<span class="px-6 py-3 rounded-full bg-gray-200 dark:bg-gray-700">Add Exercise</span>';
                currentExerciseInfo.textContent = 'Add exercises to begin';
                currentExerciseInfoFS.textContent = 'Add exercises to begin';
                upNextExercise.textContent = '--';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }

            const seqItem = workoutSequence[currentExerciseIndex];
            const exercise = exercises[seqItem.exerciseIndex];
            timerDisplay.textContent = formatTime(timeRemaining);

            if (currentPhase === 'workout') {
                exerciseTitle.textContent = exercise.name;
                phaseIndicator.innerHTML = '<span class="px-6 py-3 rounded-full bg-workout text-white">WORK</span>';
                timerDisplay.className = 'timer-display text-8xl md:text-9xl font-bold mb-8 transition-colors duration-300 text-workout';
            } else {
                exerciseTitle.textContent = 'Rest';
                phaseIndicator.innerHTML = '<span class="px-6 py-3 rounded-full bg-rest text-white">REST</span>';
                timerDisplay.className = 'timer-display text-8xl md:text-9xl font-bold mb-8 transition-colors duration-300 text-rest';
            }

            // Update "Up Next" display
            const nextEx = getNextExercise();
            if (nextEx) {
                let nextText = nextEx.name;
                if (workoutMode === 'series') {
                    nextText += ` (Set ${nextEx.round}/${nextEx.series})`;
                } else {
                    const maxSeries = Math.max(...exercises.map(ex => ex.series), 1);
                    if (nextEx.round <= maxSeries) {
                        nextText += ` - Round ${nextEx.round}`;
                    }
                }
                upNextExercise.textContent = nextText;
            } else {
                upNextExercise.textContent = 'Finish!';
            }

            // Build info text with series info
            let infoText = `${currentExerciseIndex + 1}/${workoutSequence.length}: ${exercise.name}`;
            if (workoutMode === 'series') {
                infoText += ` (Set ${seqItem.round}/${seqItem.series})`;
            } else {
                const maxSeries = Math.max(...exercises.map(ex => ex.series), 1);
                infoText += ` - Round ${seqItem.round}/${maxSeries}`;
            }

            currentExerciseInfo.textContent = infoText;
            currentExerciseInfoFS.textContent = infoText;

            // Update progress (both sidebar and fullscreen)
            const totalTime = getTotalWorkoutTime();
            const progress = totalTime > 0 ? (totalTimeElapsed / totalTime) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
            progressBarFS.style.width = `${progress}%`;
            progressTextFS.textContent = `${Math.round(progress)}%`;

            // Update button states
            prevBtn.disabled = currentExerciseIndex === 0 && currentPhase === 'workout';
            nextBtn.disabled = currentExerciseIndex === workoutSequence.length - 1 && currentPhase === 'rest';

            renderExercises();
        }

        // Get Total Workout Time
        function getTotalWorkoutTime() {
            return workoutSequence.reduce((total, seqItem) => {
                const ex = exercises[seqItem.exerciseIndex];
                return total + ex.workoutTime + ex.restTime;
            }, 0);
        }

        // Timer Tick
        function tick() {
            if (timeRemaining > 0) {
                // Play beep sound for last 5 seconds
                if (timeRemaining <= 5 && timeRemaining > 0) {
                    if (timeRemaining === 5) {
                        hasPlayedBeep = false; // Reset for this countdown
                    }
                    if (!hasPlayedBeep || timeRemaining < 5) {
                        playBeep(timeRemaining === 1 ? 1000 : 800, 0.15);
                        hasPlayedBeep = true;
                    }
                } else if (timeRemaining > 5) {
                    hasPlayedBeep = false;
                }

                timeRemaining--;
                totalTimeElapsed++;
                updateDisplay();
            } else {
                // Move to next phase
                const seqItem = workoutSequence[currentExerciseIndex];
                const exercise = exercises[seqItem.exerciseIndex];

                hasPlayedBeep = false; // Reset beep flag for next phase

                if (currentPhase === 'workout') {
                    currentPhase = 'rest';
                    timeRemaining = exercise.restTime;
                } else {
                    // Move to next exercise in sequence
                    if (currentExerciseIndex < workoutSequence.length - 1) {
                        currentExerciseIndex++;
                        currentPhase = 'workout';
                        const nextSeqItem = workoutSequence[currentExerciseIndex];
                        const nextExercise = exercises[nextSeqItem.exerciseIndex];
                        timeRemaining = nextExercise.workoutTime;
                    } else {
                        // Workout complete
                        stopTimer();
                        showWorkoutComplete();
                        return;
                    }
                }
                updateDisplay();
            }
        }

        // Start Timer
        function startTimer() {
            if (exercises.length === 0) return;

            // Initialize audio context on first user interaction
            initAudioContext();

            isRunning = true;
            playPauseBtn.innerHTML = '<i class="fas fa-pause text-3xl"></i>';
            timerInterval = setInterval(tick, 1000);
        }

        // Stop Timer
        function stopTimer() {
            isRunning = false;
            playPauseBtn.innerHTML = '<i class="fas fa-play text-3xl ml-1"></i>';
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // Reset Timer
        function resetTimer() {
            stopTimer();
            buildWorkoutSequence();
            currentExerciseIndex = 0;
            currentPhase = 'workout';
            totalTimeElapsed = 0;
            if (workoutSequence.length > 0) {
                const firstSeqItem = workoutSequence[0];
                const firstExercise = exercises[firstSeqItem.exerciseIndex];
                timeRemaining = firstExercise.workoutTime;
            }
            updateDisplay();
        }

        // Next Exercise/Phase
        function next() {
            if (workoutSequence.length === 0) return;

            const seqItem = workoutSequence[currentExerciseIndex];
            const exercise = exercises[seqItem.exerciseIndex];

            if (currentPhase === 'workout') {
                currentPhase = 'rest';
                timeRemaining = exercise.restTime;
            } else {
                if (currentExerciseIndex < workoutSequence.length - 1) {
                    currentExerciseIndex++;
                    currentPhase = 'workout';
                    const nextSeqItem = workoutSequence[currentExerciseIndex];
                    const nextExercise = exercises[nextSeqItem.exerciseIndex];
                    timeRemaining = nextExercise.workoutTime;
                }
            }
            updateDisplay();
        }

        // Previous Exercise/Phase
        function previous() {
            if (workoutSequence.length === 0) return;

            const seqItem = workoutSequence[currentExerciseIndex];
            const exercise = exercises[seqItem.exerciseIndex];

            if (currentPhase === 'rest') {
                currentPhase = 'workout';
                timeRemaining = exercise.workoutTime;
            } else {
                if (currentExerciseIndex > 0) {
                    currentExerciseIndex--;
                    currentPhase = 'rest';
                    const prevSeqItem = workoutSequence[currentExerciseIndex];
                    const prevExercise = exercises[prevSeqItem.exerciseIndex];
                    timeRemaining = prevExercise.restTime;
                }
            }
            updateDisplay();
        }

        // Show Workout Complete
        function showWorkoutComplete() {
            showCustomAlert('ðŸŽ‰ Workout Complete!', 'Great job! You\'ve completed your workout session.');
            resetTimer();
        }

        // Modal Functions
        function openAddModal() {
            editingIndex = -1;
            modalTitle.textContent = 'Add Exercise';
            exerciseName.value = '';
            workoutDuration.value = '45';
            restDuration.value = '105';
            exerciseSeries.value = '3';
            exerciseModal.classList.remove('hidden');
            exerciseName.focus();
        }

        function openEditModal(index) {
            editingIndex = index;
            const exercise = exercises[index];
            modalTitle.textContent = 'Edit Exercise';
            exerciseName.value = exercise.name;
            workoutDuration.value = exercise.workoutTime;
            restDuration.value = exercise.restTime;
            exerciseSeries.value = exercise.series || 3;
            exerciseModal.classList.remove('hidden');
            exerciseName.focus();
        }

        function closeModal() {
            exerciseModal.classList.add('hidden');
        }

        function saveExercise() {
            const name = exerciseName.value.trim();
            const workout = parseInt(workoutDuration.value);
            const rest = parseInt(restDuration.value);
            const series = parseInt(exerciseSeries.value);

            if (!name) {
                showCustomAlert('Invalid Input', 'Please enter an exercise name.');
                return;
            }

            if (workout <= 0 || rest <= 0) {
                showCustomAlert('Invalid Input', 'Workout and rest durations must be positive numbers.');
                return;
            }

            if (series <= 0) {
                showCustomAlert('Invalid Input', 'Series must be a positive number.');
                return;
            }

            if (editingIndex >= 0) {
                exercises[editingIndex] = { name, workoutTime: workout, restTime: rest, series };
            } else {
                addExercise(name, workout, rest, series);
            }

            buildWorkoutSequence();
            renderExercises();
            updateDisplay();
            closeModal();
        }

        // Delete Exercise
        function showDeleteConfirm(index) {
            showCustomConfirm(
                'Delete Exercise',
                `Are you sure you want to delete "${exercises[index].name}"?`,
                () => {
                    exercises.splice(index, 1);
                    buildWorkoutSequence();
                    if (currentExerciseIndex >= workoutSequence.length) {
                        currentExerciseIndex = Math.max(0, workoutSequence.length - 1);
                    }
                    resetTimer();
                    renderExercises();
                    updateDisplay();
                }
            );
        }

        // Move Exercise
        function moveExercise(fromIndex, toIndex) {
            if (fromIndex < 0 || fromIndex >= exercises.length ||
                toIndex < 0 || toIndex >= exercises.length) {
                return;
            }

            // Swap exercises
            const temp = exercises[fromIndex];
            exercises[fromIndex] = exercises[toIndex];
            exercises[toIndex] = temp;

            // Rebuild sequence and update display
            buildWorkoutSequence();
            renderExercises();
            updateDisplay();
        }

        // Toggle Edit Mode
        function toggleEditMode() {
            const editButtons = document.querySelectorAll('.edit-btn, .delete-btn');
            const reorderButtons = document.querySelectorAll('.reorder-btns');
            const isEditMode = editButtons[0]?.classList.contains('hidden');

            editButtons.forEach(btn => {
                if (isEditMode) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });

            reorderButtons.forEach(btn => {
                if (isEditMode) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });

            if (isEditMode) {
                editModeBtn.innerHTML = '<i class="fas fa-check"></i> Done Editing';
                editModeBtn.classList.remove('bg-primary/10', 'hover:bg-primary/20', 'text-primary');
                editModeBtn.classList.add('bg-green-500', 'hover:bg-green-600', 'text-white');
            } else {
                editModeBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Workout';
                editModeBtn.classList.add('bg-primary/10', 'hover:bg-primary/20', 'text-primary');
                editModeBtn.classList.remove('bg-green-500', 'hover:bg-green-600', 'text-white');
            }
        }

        // Save Workout to JSON
        function saveWorkout() {
            const data = {
                exercises: exercises,
                workoutMode: workoutMode,
                version: '2.0'
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'workout.json';
            a.click();
            URL.revokeObjectURL(url);
            showCustomAlert('Success', 'Workout saved successfully!');
        }

        // Load Workout from JSON
        function loadWorkout() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.exercises && Array.isArray(data.exercises)) {
                                exercises = data.exercises;

                                // Ensure all exercises have series property
                                exercises = exercises.map(ex => ({
                                    ...ex,
                                    series: ex.series || 3
                                }));

                                // Load workout mode if available
                                if (data.workoutMode) {
                                    workoutMode = data.workoutMode;
                                    workoutModeSelect.value = workoutMode;
                                    updateModeDescription();
                                }

                                buildWorkoutSequence();
                                resetTimer();
                                renderExercises();
                                updateDisplay();
                                showCustomAlert('Success', 'Workout loaded successfully!');
                            } else {
                                showCustomAlert('Error', 'Invalid workout file format.');
                            }
                        } catch (error) {
                            showCustomAlert('Error', 'Failed to load workout file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Custom Alert
        function showCustomAlert(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 slide-in">
                    <h3 class="text-xl font-bold mb-3">${title}</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                    <button class="w-full px-6 py-3 bg-primary text-white hover:bg-primary/90 rounded-lg font-medium transition-colors">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('button').onclick = () => modal.remove();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        // Custom Confirm
        function showCustomConfirm(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 slide-in">
                    <h3 class="text-xl font-bold mb-3">${title}</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                    <div class="flex gap-3">
                        <button class="cancel-btn flex-1 px-6 py-3 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                        <button class="confirm-btn flex-1 px-6 py-3 bg-red-500 text-white hover:bg-red-600 rounded-lg font-medium transition-colors">
                            Delete
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('.cancel-btn').onclick = () => modal.remove();
            modal.querySelector('.confirm-btn').onclick = () => {
                onConfirm();
                modal.remove();
            };
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        }

        // Update mode description
        function updateModeDescription() {
            const descriptions = {
                'rounds': 'Complete all exercises, then repeat the round',
                'shuffle': 'Same exercises in random order each round',
                'series': 'Finish all sets of one exercise before moving to next'
            };
            modeDescription.textContent = descriptions[workoutMode] || '';
        }

        // Workout mode change handler
        workoutModeSelect.addEventListener('change', (e) => {
            workoutMode = e.target.value;
            updateModeDescription();
            resetTimer();
        });

        // Event Listeners
        playPauseBtn.addEventListener('click', () => {
            if (isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        });

        resetBtn.addEventListener('click', () => {
            showCustomConfirm(
                'Reset Workout',
                'Are you sure you want to reset the workout?',
                resetTimer
            );
        });

        nextBtn.addEventListener('click', next);
        prevBtn.addEventListener('click', previous);
        addExerciseBtn.addEventListener('click', openAddModal);
        cancelExerciseBtn.addEventListener('click', closeModal);
        saveExerciseBtn.addEventListener('click', saveExercise);
        saveBtn.addEventListener('click', saveWorkout);
        loadBtn.addEventListener('click', loadWorkout);
        editModeBtn.addEventListener('click', toggleEditMode);

        // Function to close/hide sidebar
        function closeSidebar() {
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden');
                sidebar.classList.remove('absolute', 'z-40');
                toggleSidebar.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                sidebar.classList.add('hidden');
                toggleSidebar.innerHTML = '<i class="fas fa-bars"></i>';
            }
        }

        // Function to open/show sidebar
        function openSidebar() {
            if (window.innerWidth < 768) {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('absolute', 'z-40', 'h-full');
                toggleSidebar.innerHTML = '<i class="fas fa-times"></i>';
            } else {
                sidebar.classList.remove('hidden');
                toggleSidebar.innerHTML = '<i class="fas fa-times"></i>';
            }
        }

        // Sidebar toggle (works on both mobile and desktop)
        toggleSidebar.addEventListener('click', (e) => {
            e.stopPropagation();

            if (sidebar.classList.contains('hidden')) {
                openSidebar();
            } else {
                closeSidebar();
            }
        });

        // Close sidebar button
        closeSidebarBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeSidebar();
        });

        // Close sidebar when clicking outside on mobile
        timerArea.addEventListener('click', () => {
            if (window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
                closeSidebar();
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                // Reset mobile overlay classes
                sidebar.classList.remove('absolute', 'z-40');
                // Keep sidebar visible on desktop unless explicitly hidden
            } else {
                // On mobile, keep sidebar hidden unless explicitly shown
                if (!sidebar.classList.contains('absolute')) {
                    sidebar.classList.add('hidden');
                }
                toggleSidebar.innerHTML = sidebar.classList.contains('hidden') ? '<i class="fas fa-bars"></i>' : '<i class="fas fa-times"></i>';
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !exerciseModal.classList.contains('hidden') === false) {
                e.preventDefault();
                if (isRunning) {
                    stopTimer();
                } else {
                    startTimer();
                }
            }
        });

        // Modal keyboard handling
        exerciseName.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                saveExercise();
            }
        });

        // Initialize app
        init();
        updateModeDescription();
    </script>
</body>
</html>