<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Timer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF8C00',
                        'primary-dark': '#FF6B00',
                        'industrial-orange': '#FF8C00',
                        'industrial-yellow': '#FFB300',
                        'industrial-dark': '#1A1A1A',
                        'industrial-steel': '#2D2D2D',
                        'industrial-light': '#3A3A3A',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .timer-display {
            font-family: 'Inter', monospace;
            font-weight: 700;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.1s linear;
        }
        
        .pulse-animation {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .timeline-item {
            transition: all 0.2s ease;
        }
        
        .timeline-active {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(255, 140, 0, 0.4);
        }
        
        /* Rep Progress Squares */
        .rep-square {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin: 2px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 140, 0, 0.3);
        }

        .rep-square.completed {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }

        .rep-square.current {
            background: linear-gradient(135deg, #FF8C00, #FFB300);
            animation: pulse-rep 1s infinite;
            box-shadow: 0 0 12px rgba(255, 140, 0, 0.7);
        }

        .rep-square.remaining {
            background: rgba(255, 140, 0, 0.15);
            border: 1px solid rgba(255, 140, 0, 0.3);
        }

        @keyframes pulse-rep {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .exercise-progress {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1px;
            padding: 8px;
            background: rgba(255, 140, 0, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 140, 0, 0.2);
        }

        /* Drag and Drop Styles */
        .drag-mode .timeline-item {
            cursor: grab;
            user-select: none;
        }

        .drag-mode .timeline-item:active {
            cursor: grabbing;
        }

        .dragging {
            opacity: 0.5;
            transform: scale(1.05);
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .drag-over {
            border-top: 4px solid #8B5CF6 !important;
            transform: translateY(2px);
        }

        .drag-placeholder {
            height: 4px;
            background: linear-gradient(90deg, #8B5CF6, #A855F7);
            border-radius: 2px;
            margin: 8px 0;
            opacity: 0.8;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-industrial-dark via-industrial-steel to-black flex items-center justify-center z-50">
        <div class="bg-industrial-steel border-2 border-industrial-orange rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">‚ö°</div>
                <h1 class="text-3xl font-bold text-white mb-2">WORKOUT TIMER PRO</h1>
                <p class="text-orange-300 font-medium">ENTER CODE TO ACCESS TRAINING</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="passwordInput" class="block text-sm font-bold mb-2 text-orange-300">ACCESS CODE</label>
                    <input type="password" id="passwordInput" 
                           class="w-full px-4 py-3 text-base border-2 border-industrial-orange rounded-lg bg-industrial-dark text-white focus:ring-2 focus:ring-industrial-yellow focus:border-industrial-yellow font-mono"
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                
                <button type="submit" class="w-full bg-gradient-to-r from-industrial-orange to-industrial-yellow text-black py-3 rounded-lg font-bold transition-all transform hover:scale-105 hover:shadow-lg">
                    ‚ö° UNLOCK SYSTEM
                </button>
                
                <div id="loginError" class="hidden text-red-400 text-sm text-center bg-red-900/30 border border-red-600 p-3 rounded-lg">
                    ‚ö†Ô∏è ACCESS DENIED. TRY AGAIN.
                </div>
            </form>
            
            <div class="mt-6 text-center">
                <div class="text-xs text-orange-500 font-medium">
                    üîí SECURED TRAINING ACCESS SYSTEM
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <!-- Logout Button -->
        <div class="fixed top-4 right-4 z-40">
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all transform hover:scale-105">
                üîí Logout
            </button>
        </div>
        
        <div class="container mx-auto px-4 py-6 max-w-6xl">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-center mb-2">Workout Timer Pro</h1>
                <p class="text-gray-600 dark:text-gray-400 text-center">Design and execute your perfect workout</p>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Timer Section -->
                <div class="space-y-6">
                    <!-- Main Timer Display -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-3xl p-8 text-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-primary/10 to-transparent"></div>
                        <div class="relative z-10">
                            <!-- Current Exercise Info -->
                            <div class="mb-6">
                                <h2 class="text-xl font-semibold mb-2" id="currentExercise">Ready to Start</h2>
                                <div class="flex justify-center items-center space-x-4 text-sm text-gray-600 dark:text-gray-400">
                                    <span id="currentRep">No workout loaded</span>
                                    <span id="currentPhase" class="px-3 py-1 rounded-full text-xs font-bold">READY</span>
                                </div>
                            </div>

                            <!-- Circular Progress Timer -->
                            <div class="relative mx-auto mb-6" style="width: 200px; height: 200px;">
                                <svg class="progress-ring w-full h-full">
                                    <circle cx="100" cy="100" r="90" fill="transparent" stroke="currentColor" 
                                            stroke-width="4" class="text-gray-300 dark:text-gray-600"></circle>
                                    <circle cx="100" cy="100" r="90" fill="transparent" stroke="currentColor" 
                                            stroke-width="6" class="text-primary progress-ring-circle" 
                                            stroke-dasharray="565.48" stroke-dashoffset="565.48" id="progressCircle"></circle>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="text-center">
                                        <div class="timer-display text-4xl font-bold" id="timerDisplay">00:00</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="timerLabel">Ready</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Rep Progress Visualization -->
                            <div class="mb-6" id="repProgressContainer" style="display: none;">
                                <h3 class="text-sm font-medium text-center mb-3 text-gray-600 dark:text-gray-400">Rep Progress</h3>
                                <div class="exercise-progress" id="repProgressSquares"></div>
                            </div>

                            <!-- Control Buttons -->
                            <div class="flex justify-center space-x-3 flex-wrap gap-2">
                                <button id="startBtn" class="bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-full font-semibold transition-all transform hover:scale-105">
                                    Start Workout
                                </button>
                                <button id="pauseBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-full font-semibold transition-all transform hover:scale-105 hidden">
                                    Pause
                                </button>
                                <button id="skipBtn" class="bg-green-500 hover:bg-green-600 text-white px-5 py-3 rounded-full font-semibold transition-all transform hover:scale-105 hidden">
                                    Skip Rest
                                </button>
                                <button id="resetPhaseBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-3 rounded-full font-semibold transition-all transform hover:scale-105">
                                    Reset Phase
                                </button>
                                <button id="resetWorkoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-5 py-3 rounded-full font-semibold transition-all transform hover:scale-105">
                                    Reset Workout
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Info (for testing) -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-4">
                        <h3 class="text-sm font-semibold mb-2">Debug Info</h3>
                        <div class="text-xs space-y-1 mb-3" id="debugInfo">
                            <div>Status: <span id="debugStatus">Ready</span></div>
                            <div>Exercise: <span id="debugExercise">-</span></div>
                            <div>Rep: <span id="debugRep">-</span></div>
                            <div>Phase: <span id="debugPhase">-</span></div>
                            <div>Time: <span id="debugTime">-</span></div>
                        </div>
                        <button id="testAudioBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded text-xs font-semibold transition-all">
                            üîä Test Audio
                        </button>
                    </div>
                </div>

                <!-- Workout Editor & Timeline -->
                <div class="space-y-6">
                    <!-- Workout Editor -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-6">
                        <h3 class="text-lg font-semibold mb-4">Workout Editor</h3>
                        
                        <!-- Add Exercise Form -->
                        <div class="space-y-4 mb-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input type="text" id="exerciseTitle" placeholder="Exercise name" 
                                       class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                                <input type="number" id="exerciseReps" placeholder="Reps" min="1" value="3"
                                       class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Work Time (seconds)</label>
                                    <input type="number" id="workTime" value="5" min="1"
                                           class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Rest Time (seconds)</label>
                                    <input type="number" id="restTime" value="3" min="0"
                                           class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <button id="addExerciseBtn" class="w-full bg-primary hover:bg-primary-dark text-white py-3 rounded-lg font-semibold transition-all">
                                Add Exercise
                            </button>
                        </div>
                        
                        <!-- Save/Load Section -->
                        <div class="border-t pt-4 space-y-3">
                            <div class="flex space-x-3">
                                <button id="saveWorkoutBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition-all">
                                    üíæ Save Workout
                                </button>
                                <button id="loadWorkoutBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition-all">
                                    üìÅ Load Workout
                                </button>
                            </div>
                            <input type="file" id="fileInput" accept=".json" style="display: none;">
                        </div>
                    </div>

                    <!-- Quick Templates -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-6">
                        <h3 class="text-lg font-semibold mb-4">Quick Test Templates</h3>
                        <div class="space-y-2">
                            <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" data-template="quick-test">
                                <div class="font-medium">Quick Test</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">1 exercise, 5s work, 3s rest, 2 reps</div>
                            </button>
                            <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" data-template="mini-hiit">
                                <div class="font-medium">Mini HIIT</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">2 exercises, 10s work, 5s rest, 2 reps each</div>
                            </button>
                        </div>
                    </div>

                    <!-- Workout Timeline -->
                    <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Workout Timeline</h3>
                            <button id="dragModeBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all transform hover:scale-105">
                                üéØ Drag Mode
                            </button>
                        </div>
                        <div id="dragModeIndicator" class="hidden bg-purple-100 dark:bg-purple-900 border border-purple-300 dark:border-purple-700 rounded-lg p-3 mb-4">
                            <div class="text-purple-700 dark:text-purple-300 text-sm">
                                üì± <strong>Drag Mode Active:</strong> Touch and drag exercises to reorder them
                            </div>
                        </div>
                        <div id="workoutTimeline" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                                No exercises added yet. Add your first exercise above or use a template!
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === GLOBAL STATE ===
        let workoutState = {
            exercises: [],
            currentExerciseIndex: 0,
            currentRep: 0,
            isWorkPhase: true,
            timeRemaining: 0,
            isRunning: false,
            isPaused: false,
            totalWorkoutTime: 0,
            elapsedTime: 0,
            timerInterval: null
        };

        let audioContext = null;

        // === UTILITY FUNCTIONS ===
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function log(message, data = null) {
            console.log(`[WORKOUT TIMER] ${message}`, data || '');
        }

        // === AUDIO FUNCTIONS ===
        function initializeAudio() {
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (AudioCtx) {
                    audioContext = new AudioCtx();
                    log('Audio context created, state:', audioContext.state);
                } else {
                    log('AudioContext not supported');
                }
            } catch (e) {
                log('Audio initialization failed:', e);
            }
        }

        function ensureAudioContext() {
            if (!audioContext) {
                initializeAudio();
            }
            
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    log('Audio context resumed');
                }).catch(e => {
                    log('Failed to resume audio context:', e);
                });
            }
        }

        function playBeep(frequency = 800, duration = 200) {
            ensureAudioContext();
            
            if (!audioContext) {
                log('No audio context available');
                return;
            }
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration / 1000);
                
                log(`Beep played: ${frequency}Hz for ${duration}ms`);
            } catch (e) {
                log('Beep failed:', e);
            }
        }

        function testAudio() {
            log('Testing audio...');
            playBeep(800, 300);
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded">OK</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            
            modal.querySelector('.ok-btn').addEventListener('click', () => modal.remove());
        }

        // === WORKOUT MANAGEMENT ===
        function addExercise() {
            const title = document.getElementById('exerciseTitle').value.trim();
            const reps = parseInt(document.getElementById('exerciseReps').value) || 1;
            const workTime = parseInt(document.getElementById('workTime').value) || 5;
            const restTime = parseInt(document.getElementById('restTime').value) || 0;

            if (!title) {
                showAlert('Please enter an exercise name');
                return;
            }

            if (reps < 1 || workTime < 1 || restTime < 0) {
                showAlert('Please enter valid positive numbers');
                return;
            }

            const exercise = { 
                title: title.trim(), 
                reps: Math.max(1, reps), 
                workTime: Math.max(1, workTime), 
                restTime: Math.max(0, restTime) 
            };
            
            workoutState.exercises.push(exercise);
            log('Added exercise:', exercise);
            
            // Clear form
            document.getElementById('exerciseTitle').value = '';
            document.getElementById('exerciseReps').value = '3';
            document.getElementById('workTime').value = '5';
            document.getElementById('restTime').value = '3';
            
            updateTimeline();
            updateDisplay();
        }

        function loadTemplate(templateType) {
            let exercises = [];
            
            switch(templateType) {
                case 'quick-test':
                    exercises = [
                        { title: 'Test Exercise', reps: 2, workTime: 5, restTime: 3 }
                    ];
                    break;
                case 'mini-hiit':
                    exercises = [
                        { title: 'Jumping Jacks', reps: 2, workTime: 10, restTime: 5 },
                        { title: 'High Knees', reps: 2, workTime: 10, restTime: 5 }
                    ];
                    break;
            }
            
            if (exercises.length > 0) {
                workoutState.exercises = exercises;
                log('Loaded template:', templateType);
                updateTimeline();
                updateDisplay();
            }
        }

        function calculateTotalTime() {
            workoutState.totalWorkoutTime = 0;
            workoutState.exercises.forEach(exercise => {
                // For each rep: work time + rest time (except last rep of each exercise)
                workoutState.totalWorkoutTime += exercise.reps * exercise.workTime;
                workoutState.totalWorkoutTime += (exercise.reps - 1) * exercise.restTime; // No rest after last rep of exercise
            });
            log('Total workout time calculated:', workoutState.totalWorkoutTime + 's');
        }

        // === TIMER CORE FUNCTIONS ===
        function startWorkout() {
            if (workoutState.exercises.length === 0) {
                showAlert('Please add at least one exercise to start the workout');
                return;
            }

            // Enable audio context if needed
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (workoutState.isPaused) {
                // Resume from pause
                workoutState.isPaused = false;
                log('Resuming workout from pause');
            } else {
                // Start fresh workout
                resetWorkoutState();
                log('Starting fresh workout');
            }

            workoutState.isRunning = true;
            updateButtons();
            updateDisplay();
            startTimer();
        }

        function pauseWorkout() {
            workoutState.isPaused = true;
            workoutState.isRunning = false;
            stopTimer();
            updateButtons();
            log('Workout paused');
        }

        function resetPhase() {
            if (!workoutState.isRunning && !workoutState.isPaused) {
                log('Cannot reset phase - no active workout');
                return;
            }
            
            stopTimer();
            
            // Reset current phase timer only
            const currentExercise = workoutState.exercises[workoutState.currentExerciseIndex];
            if (workoutState.isWorkPhase) {
                workoutState.timeRemaining = currentExercise.workTime;
                log('Reset work phase timer');
            } else {
                workoutState.timeRemaining = currentExercise.restTime;
                log('Reset rest phase timer');
            }
            
            updateDisplay();
            
            // Restart timer if workout was running
            if (workoutState.isRunning) {
                startTimer();
            }
            
            log('Phase reset');
        }

        function resetWorkout() {
            stopTimer();
            resetWorkoutState();
            updateButtons();
            updateDisplay();
            log('Full workout reset');
        }

        function resetWorkoutState() {
            workoutState.currentExerciseIndex = 0;
            workoutState.currentRep = 0;
            workoutState.isWorkPhase = true;
            workoutState.elapsedTime = 0;
            workoutState.isRunning = false;
            workoutState.isPaused = false;
            
            if (workoutState.exercises.length > 0) {
                workoutState.timeRemaining = workoutState.exercises[0].workTime;
            } else {
                workoutState.timeRemaining = 0;
            }
            
            calculateTotalTime();
        }

        function startTimer() {
            if (workoutState.timerInterval) {
                clearInterval(workoutState.timerInterval);
            }

            workoutState.timerInterval = setInterval(() => {
                if (workoutState.timeRemaining <= 0) {
                    // End beep when timer completes
                    playBeep(1000, 300);
                    handleTimerComplete();
                    return;
                }

                // Countdown beeps for last 5 seconds
                if (workoutState.timeRemaining <= 5 && workoutState.timeRemaining > 0) {
                    playBeep(600, 150);
                }

                workoutState.timeRemaining--;
                workoutState.elapsedTime++;
                updateDisplay();
            }, 1000);

            log('Timer started');
        }

        function stopTimer() {
            if (workoutState.timerInterval) {
                clearInterval(workoutState.timerInterval);
                workoutState.timerInterval = null;
            }
            log('Timer stopped');
        }

        function handleTimerComplete() {
            log('Timer completed - transitioning phase');
            
            const currentExercise = workoutState.exercises[workoutState.currentExerciseIndex];
            
            if (workoutState.isWorkPhase) {
                // Work phase complete - go to rest (if rest time > 0)
                if (currentExercise.restTime > 0) {
                    workoutState.isWorkPhase = false;
                    workoutState.timeRemaining = currentExercise.restTime;
                    log(`Switching to REST phase: ${workoutState.timeRemaining}s`);
                    updateDisplay();
                    return; // Continue timer for rest phase
                } else {
                    // No rest time - go directly to next rep/exercise
                    log('No rest time - skipping to next rep/exercise');
                }
            }
            
            // Rest phase complete OR work phase with no rest - advance to next rep/exercise
            advanceToNext();
        }

        function advanceToNext() {
            const currentExercise = workoutState.exercises[workoutState.currentExerciseIndex];
            
            workoutState.currentRep++;
            log(`Advancing to rep ${workoutState.currentRep + 1} of ${currentExercise.reps}`);
            
            if (workoutState.currentRep >= currentExercise.reps) {
                // Move to next exercise
                workoutState.currentExerciseIndex++;
                workoutState.currentRep = 0;
                
                if (workoutState.currentExerciseIndex >= workoutState.exercises.length) {
                    // Workout complete!
                    completeWorkout();
                    return;
                }
                
                log(`Moving to next exercise: ${workoutState.exercises[workoutState.currentExerciseIndex].title}`);
            }
            
            // Set up for next work phase
            workoutState.isWorkPhase = true;
            const nextExercise = workoutState.exercises[workoutState.currentExerciseIndex];
            workoutState.timeRemaining = nextExercise.workTime;
            
            log(`Starting work phase: ${workoutState.timeRemaining}s`);
            updateDisplay();
        }

        function skipRest() {
            if (!workoutState.isRunning || workoutState.isWorkPhase) return;
            
            log('Skipping rest phase');
            workoutState.timeRemaining = 0; // This will trigger handleTimerComplete on next tick
        }

        function completeWorkout() {
            stopTimer();
            workoutState.isRunning = false;
            workoutState.isPaused = false;
            
            // Celebration beeps
            setTimeout(() => playBeep(800, 200), 0);
            setTimeout(() => playBeep(1000, 200), 200);
            setTimeout(() => playBeep(1200, 300), 400);
            
            log('üéâ WORKOUT COMPLETE! üéâ');
            showAlert('üéâ Workout Complete! Great job! üéâ');
            
            updateButtons();
            updateDisplay();
        }

        // === UI UPDATE FUNCTIONS ===
        function updateDisplay() {
            if (workoutState.exercises.length === 0) {
                document.getElementById('currentExercise').textContent = 'Ready to Start';
                document.getElementById('currentRep').textContent = 'No workout loaded';
                document.getElementById('currentPhase').textContent = 'READY';
                document.getElementById('currentPhase').className = 'px-3 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-700';
                document.getElementById('timerDisplay').textContent = '00:00';
                document.getElementById('timerLabel').textContent = 'Ready';
                document.getElementById('repProgressContainer').style.display = 'none';
                updateDebugInfo();
                return;
            }

            const currentExercise = workoutState.exercises[workoutState.currentExerciseIndex];
            
            // Update exercise info
            document.getElementById('currentExercise').textContent = currentExercise.title;
            document.getElementById('currentRep').textContent = `Rep ${workoutState.currentRep + 1} of ${currentExercise.reps}`;
            
            // Update phase display
            const phaseElement = document.getElementById('currentPhase');
            if (workoutState.isWorkPhase) {
                phaseElement.textContent = 'WORK';
                phaseElement.className = 'px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white';
                document.getElementById('timerLabel').textContent = 'Work Time';
            } else {
                phaseElement.textContent = 'REST';
                phaseElement.className = 'px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white';
                document.getElementById('timerLabel').textContent = 'Rest Time';
            }
            
            // Update timer display
            document.getElementById('timerDisplay').textContent = formatTime(workoutState.timeRemaining);
            
            // Update progress circle
            const totalTime = workoutState.isWorkPhase ? currentExercise.workTime : currentExercise.restTime;
            const progress = totalTime > 0 ? (workoutState.timeRemaining / totalTime) * 100 : 0;
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (progress / 100 * circumference);
            document.getElementById('progressCircle').style.strokeDashoffset = offset;
            
            // Update rep progress
            updateRepProgress();
            
            // Update skip button
            updateSkipButton();
            
            // Update debug info
            updateDebugInfo();
        }

        function updateRepProgress() {
            if (workoutState.exercises.length === 0) {
                document.getElementById('repProgressContainer').style.display = 'none';
                return;
            }
            
            const currentExercise = workoutState.exercises[workoutState.currentExerciseIndex];
            document.getElementById('repProgressContainer').style.display = 'block';
            
            const container = document.getElementById('repProgressSquares');
            let html = '';
            
            for (let i = 0; i < currentExercise.reps; i++) {
                let squareClass = 'rep-square ';
                
                if (i < workoutState.currentRep) {
                    squareClass += 'completed';
                } else if (i === workoutState.currentRep && workoutState.isRunning) {
                    squareClass += 'current';
                } else {
                    squareClass += 'remaining';
                }
                
                html += `<div class="${squareClass}" title="Rep ${i + 1}"></div>`;
            }
            
            container.innerHTML = html;
        }

        function updateButtons() {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const skipBtn = document.getElementById('skipBtn');
            
            if (workoutState.isRunning) {
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
                
                if (workoutState.isPaused) {
                    startBtn.textContent = 'Resume Workout';
                } else {
                    startBtn.textContent = 'Start Workout';
                }
            }
            
            updateSkipButton();
        }

        function updateSkipButton() {
            const skipBtn = document.getElementById('skipBtn');
            if (workoutState.isRunning && !workoutState.isWorkPhase) {
                skipBtn.style.display = 'inline-block';
            } else {
                skipBtn.style.display = 'none';
            }
        }

        function updateDebugInfo() {
            document.getElementById('debugStatus').textContent = workoutState.isRunning ? 'RUNNING' : (workoutState.isPaused ? 'PAUSED' : 'STOPPED');
            document.getElementById('debugExercise').textContent = workoutState.exercises.length > 0 ? `${workoutState.currentExerciseIndex + 1}/${workoutState.exercises.length}` : 'None';
            document.getElementById('debugRep').textContent = workoutState.exercises.length > 0 ? `${workoutState.currentRep + 1}/${workoutState.exercises[workoutState.currentExerciseIndex]?.reps || 0}` : 'None';
            document.getElementById('debugPhase').textContent = workoutState.isWorkPhase ? 'WORK' : 'REST';
            document.getElementById('debugTime').textContent = formatTime(workoutState.timeRemaining);
        }

        function updateTimeline() {
            const timeline = document.getElementById('workoutTimeline');
            
            if (workoutState.exercises.length === 0) {
                timeline.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">No exercises added yet. Add your first exercise above or use a template!</div>';
                return;
            }

            let html = '';
            workoutState.exercises.forEach((exercise, index) => {
                const isActive = workoutState.isRunning && index === workoutState.currentExerciseIndex;
                const borderClass = isActive ? 'border-primary timeline-active' : 'border-gray-300 dark:border-gray-600';
                const titleClass = isActive ? 'text-primary' : '';
                
                html += `
                    <div class="timeline-item bg-white dark:bg-gray-700 p-4 rounded-lg border-l-4 ${borderClass}" 
                         draggable="true" 
                         ondragstart="handleDragStart(event)" 
                         ondragover="handleDragOver(event)" 
                         ondragleave="handleDragLeave(event)" 
                         ondrop="handleDrop(event)" 
                         ondragend="handleDragEnd(event)"
                         ontouchstart="handleTouchStart(event)"
                         ontouchmove="handleTouchMove(event)"
                         ontouchend="handleTouchEnd(event)">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold ${titleClass}">${exercise.title}</h4>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                    ${exercise.reps} reps √ó ${exercise.workTime}s work / ${exercise.restTime}s rest
                                </div>
                                ${isActive ? `<div class="text-xs text-primary mt-1 font-medium">Rep ${workoutState.currentRep + 1} of ${exercise.reps} - ${workoutState.isWorkPhase ? 'WORK' : 'REST'}</div>` : ''}
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button class="edit-exercise-btn text-blue-500 hover:text-blue-700 text-sm" data-index="${index}">Edit</button>
                                <button class="delete-exercise-btn text-red-500 hover:text-red-700 text-sm" data-index="${index}">Delete</button>
                            </div>
                        </div>
                    </div>`;
            });
            
            timeline.innerHTML = html;
        }

        function deleteExercise(index) {
            if (workoutState.isRunning) {
                showAlert('Cannot delete exercises during a workout. Please stop the workout first.');
                return;
            }
            
            workoutState.exercises.splice(index, 1);
            log('Deleted exercise at index:', index);
            
            updateTimeline();
            updateDisplay();
        }

        // === EDIT EXERCISE FUNCTIONS ===
        function editExercise(index) {
            if (workoutState.isRunning) {
                showAlert('Cannot edit exercises during a workout. Please stop the workout first.');
                return;
            }
            
            const exercise = workoutState.exercises[index];
            if (!exercise) return;

            // Find the timeline item
            const timelineItem = document.querySelector(`[data-index="${index}"]`).closest('.timeline-item');
            const originalContent = timelineItem.innerHTML;
            
            // Create edit form
            timelineItem.innerHTML = `
                <div class="space-y-3">
                    <input type="text" value="${exercise.title}" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent edit-title" placeholder="Exercise name">
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-xs font-medium mb-1">Reps</label>
                            <input type="number" value="${exercise.reps}" min="1" class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent edit-reps">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Work (s)</label>
                            <input type="number" value="${exercise.workTime}" min="1" class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent edit-work">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Rest (s)</label>
                            <input type="number" value="${exercise.restTime}" min="0" class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent edit-rest">
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="save-edit-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-semibold transition-all">
                            ‚úÖ Save
                        </button>
                        <button class="cancel-edit-btn bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm font-semibold transition-all">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            `;

            // Focus on the title input
            const titleInput = timelineItem.querySelector('.edit-title');
            titleInput.focus();
            titleInput.select();

            // Save button handler
            const saveBtn = timelineItem.querySelector('.save-edit-btn');
            saveBtn.addEventListener('click', function() {
                const newTitle = timelineItem.querySelector('.edit-title').value.trim();
                const newReps = parseInt(timelineItem.querySelector('.edit-reps').value);
                const newWork = parseInt(timelineItem.querySelector('.edit-work').value);
                const newRest = parseInt(timelineItem.querySelector('.edit-rest').value);

                // Validate inputs
                if (!newTitle) {
                    showAlert('Please enter an exercise name');
                    return;
                }
                
                if (isNaN(newReps) || newReps < 1) {
                    showAlert('Reps must be at least 1');
                    return;
                }
                
                if (isNaN(newWork) || newWork < 1) {
                    showAlert('Work time must be at least 1 second');
                    return;
                }
                
                if (isNaN(newRest) || newRest < 0) {
                    showAlert('Rest time cannot be negative');
                    return;
                }

                // Update the exercise
                workoutState.exercises[index] = {
                    title: newTitle,
                    reps: newReps,
                    workTime: newWork,
                    restTime: newRest
                };
                
                log('Exercise edited:', workoutState.exercises[index]);
                resetWorkoutState();
                updateTimeline();
                updateDisplay();
                showAlert('Exercise updated successfully!');
            });

            // Cancel button handler
            const cancelBtn = timelineItem.querySelector('.cancel-edit-btn');
            cancelBtn.addEventListener('click', function() {
                timelineItem.innerHTML = originalContent;
            });

            // Enter key to save, Escape to cancel
            timelineItem.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveBtn.click();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelBtn.click();
                }
            });
        }

        // === DRAG AND DROP FUNCTIONS ===
        let isDragMode = false;
        let draggedItem = null;
        let draggedIndex = null;

        function toggleDragMode() {
            isDragMode = !isDragMode;
            const timeline = document.getElementById('workoutTimeline');
            const dragModeBtn = document.getElementById('dragModeBtn');
            const dragModeIndicator = document.getElementById('dragModeIndicator');
            
            if (isDragMode) {
                timeline.classList.add('drag-mode');
                dragModeBtn.textContent = '‚úÖ Exit Drag';
                dragModeBtn.className = 'bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all transform hover:scale-105';
                dragModeIndicator.classList.remove('hidden');
                log('Drag mode enabled');
            } else {
                timeline.classList.remove('drag-mode');
                dragModeBtn.textContent = 'üéØ Drag Mode';
                dragModeBtn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all transform hover:scale-105';
                dragModeIndicator.classList.add('hidden');
                log('Drag mode disabled');
            }
        }

        function handleDragStart(e) {
            if (!isDragMode) return;
            
            draggedItem = e.target.closest('.timeline-item');
            if (!draggedItem) return;
            
            draggedIndex = parseInt(draggedItem.querySelector('[data-index]').getAttribute('data-index'));
            
            draggedItem.classList.add('dragging');
            
            // Set drag data
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedItem.outerHTML);
            
            log('Drag started for exercise index:', draggedIndex);
        }

        function handleDragOver(e) {
            if (!isDragMode || !draggedItem) return;
            
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const targetItem = e.target.closest('.timeline-item');
            if (targetItem && targetItem !== draggedItem) {
                targetItem.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (!isDragMode) return;
            
            const targetItem = e.target.closest('.timeline-item');
            if (targetItem) {
                targetItem.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (!isDragMode || !draggedItem) return;
            
            e.preventDefault();
            
            const targetItem = e.target.closest('.timeline-item');
            if (!targetItem || targetItem === draggedItem) {
                cleanupDrag();
                return;
            }
            
            const targetIndex = parseInt(targetItem.querySelector('[data-index]').getAttribute('data-index'));
            
            // Move the exercise in the array
            const draggedExercise = workoutState.exercises[draggedIndex];
            workoutState.exercises.splice(draggedIndex, 1);
            
            // Adjust target index if we removed an item before it
            const insertIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
            workoutState.exercises.splice(insertIndex, 0, draggedExercise);
            
            log(`Moved exercise from index ${draggedIndex} to ${insertIndex}`);
            
            // Update display
            resetWorkoutState();
            updateTimeline();
            updateDisplay();
            
            cleanupDrag();
            showAlert('Exercise reordered successfully!');
        }

        function handleDragEnd(e) {
            cleanupDrag();
        }

        function cleanupDrag() {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            
            // Remove drag-over class from all items
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            
            draggedItem = null;
            draggedIndex = null;
        }

        // Touch events for mobile drag and drop
        let touchStartY = 0;
        let touchCurrentY = 0;
        let isTouchDragging = false;

        function handleTouchStart(e) {
            if (!isDragMode) return;
            
            const touch = e.touches[0];
            touchStartY = touch.clientY;
            touchCurrentY = touch.clientY;
            
            draggedItem = e.target.closest('.timeline-item');
            if (!draggedItem) return;
            
            draggedIndex = parseInt(draggedItem.querySelector('[data-index]').getAttribute('data-index'));
            
            // Prevent default to avoid scrolling
            e.preventDefault();
            
            log('Touch drag started for exercise index:', draggedIndex);
        }

        function handleTouchMove(e) {
            if (!isDragMode || !draggedItem) return;
            
            e.preventDefault();
            
            const touch = e.touches[0];
            touchCurrentY = touch.clientY;
            
            if (!isTouchDragging && Math.abs(touchCurrentY - touchStartY) > 10) {
                isTouchDragging = true;
                draggedItem.classList.add('dragging');
            }
            
            if (isTouchDragging) {
                // Find the element under the touch point
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const targetItem = elementBelow?.closest('.timeline-item');
                
                // Remove drag-over from all items
                document.querySelectorAll('.timeline-item').forEach(item => {
                    item.classList.remove('drag-over');
                });
                
                // Add drag-over to target
                if (targetItem && targetItem !== draggedItem) {
                    targetItem.classList.add('drag-over');
                }
            }
        }

        function handleTouchEnd(e) {
            if (!isDragMode || !draggedItem || !isTouchDragging) {
                cleanupTouch();
                return;
            }
            
            // Find the element under the final touch point
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetItem = elementBelow?.closest('.timeline-item');
            
            if (targetItem && targetItem !== draggedItem) {
                const targetIndex = parseInt(targetItem.querySelector('[data-index]').getAttribute('data-index'));
                
                // Move the exercise in the array
                const draggedExercise = workoutState.exercises[draggedIndex];
                workoutState.exercises.splice(draggedIndex, 1);
                
                // Adjust target index if we removed an item before it
                const insertIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
                workoutState.exercises.splice(insertIndex, 0, draggedExercise);
                
                log(`Touch moved exercise from index ${draggedIndex} to ${insertIndex}`);
                
                // Update display
                resetWorkoutState();
                updateTimeline();
                updateDisplay();
                
                showAlert('Exercise reordered successfully!');
            }
            
            cleanupTouch();
        }

        function cleanupTouch() {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
            }
            
            // Remove drag-over class from all items
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            
            draggedItem = null;
            draggedIndex = null;
            isTouchDragging = false;
            touchStartY = 0;
            touchCurrentY = 0;
        }

        // === SAVE/LOAD FUNCTIONS ===
        function saveWorkout() {
            if (workoutState.exercises.length === 0) {
                showAlert('No exercises to save! Add some exercises first.');
                return;
            }

            const workoutData = {
                name: 'My Workout - ' + new Date().toLocaleDateString(),
                exercises: workoutState.exercises,
                created: new Date().toISOString(),
                totalTime: workoutState.totalWorkoutTime
            };

            const dataStr = JSON.stringify(workoutData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'workout-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            
            log('Workout saved:', workoutData);
            showAlert('Workout saved successfully!');
        }

        function loadWorkout() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workoutData = JSON.parse(e.target.result);
                    
                    if (workoutData.exercises && Array.isArray(workoutData.exercises)) {
                        // Validate exercise structure
                        const validExercises = workoutData.exercises.filter(exercise => {
                            return exercise.title && 
                                   typeof exercise.reps === 'number' && exercise.reps > 0 &&
                                   typeof exercise.workTime === 'number' && exercise.workTime > 0 &&
                                   typeof exercise.restTime === 'number' && exercise.restTime >= 0;
                        });

                        if (validExercises.length > 0) {
                            workoutState.exercises = validExercises;
                            resetWorkoutState();
                            updateTimeline();
                            updateDisplay();
                            log('Workout loaded:', workoutData);
                            showAlert(`Workout loaded successfully! ${validExercises.length} exercises loaded.`);
                        } else {
                            showAlert('No valid exercises found in the workout file.');
                        }
                    } else {
                        showAlert('Invalid workout file format. Please check that the file contains valid exercise data.');
                    }
                } catch (error) {
                    log('Error loading workout file:', error);
                    showAlert('Error loading workout file. Please make sure it\'s a valid JSON file.');
                }
            };
            reader.readAsText(file);
            
            // Clear the file input so the same file can be loaded again
            event.target.value = '';
        }

        // === DARK MODE ===
        function initializeDarkMode() {
            try {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                }
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                        if (event.matches) {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                    });
                }
            } catch (e) {
                log('Dark mode detection failed');
            }
        }

        // === LOGIN SYSTEM ===
        const correctPassword = "WorkNow2025";

        function handleLogin(event) {
            event.preventDefault();
            
            const passwordInput = document.getElementById('passwordInput');
            const loginError = document.getElementById('loginError');
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === correctPassword) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                passwordInput.value = '';
                loginError.classList.add('hidden');
                log('Login successful');
            } else {
                loginError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function logout() {
            resetWorkout();
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hidden');
            setTimeout(() => document.getElementById('passwordInput').focus(), 100);
            log('Logged out');
        }

        // === INITIALIZATION ===
        document.addEventListener('DOMContentLoaded', function() {
            log('Initializing Workout Timer Pro');
            
            initializeDarkMode();
            initializeAudio();
            
            // Event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('startBtn').addEventListener('click', startWorkout);
            document.getElementById('pauseBtn').addEventListener('click', pauseWorkout);
            document.getElementById('resetPhaseBtn').addEventListener('click', resetPhase);
            document.getElementById('resetWorkoutBtn').addEventListener('click', resetWorkout);
            document.getElementById('skipBtn').addEventListener('click', skipRest);
            document.getElementById('addExerciseBtn').addEventListener('click', addExercise);
            document.getElementById('testAudioBtn').addEventListener('click', testAudio);
            document.getElementById('saveWorkoutBtn').addEventListener('click', saveWorkout);
            document.getElementById('loadWorkoutBtn').addEventListener('click', loadWorkout);
            document.getElementById('fileInput').addEventListener('change', handleFileLoad);
            document.getElementById('dragModeBtn').addEventListener('click', toggleDragMode);
            
            // Event delegation for dynamic elements
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-exercise-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    deleteExercise(index);
                }
                if (e.target.classList.contains('edit-exercise-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    editExercise(index);
                }
                if (e.target.classList.contains('template-btn')) {
                    const template = e.target.getAttribute('data-template');
                    loadTemplate(template);
                }
            });
            
            // Initialize display
            resetWorkoutState();
            updateDisplay();
            updateTimeline();
            
            // Focus password field
            document.getElementById('passwordInput').focus();
            
            log('Initialization complete');
        });
    </script>
</body>
</html>