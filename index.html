<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Timer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4c4bb8',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .timer-display {
            font-family: 'Inter', monospace;
            font-weight: 700;
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dashoffset 0.1s linear;
        }
        
        .pulse-animation {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .workout-item {
            transition: all 0.3s ease;
        }
        
        .workout-item:hover {
            transform: translateY(-2px);
        }
        
        .timeline-item {
            transition: all 0.2s ease;
        }
        
        .timeline-active {
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(93, 92, 222, 0.3);
        }
        
        .dashboard-mode {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
        }
        
        .dashboard-mode.active {
            display: flex;
        }
        
        .big-timer {
            font-size: 8rem;
            line-height: 1;
        }
        
        .big-progress {
            width: 400px;
            height: 400px;
        }
        
        .floating-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .glow-animation {
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(93, 92, 222, 0.5); }
            to { box-shadow: 0 0 40px rgba(93, 92, 222, 0.8); }
        }
        
        @media (max-width: 768px) {
            .big-timer {
                font-size: 4rem;
            }
            .big-progress {
                width: 280px;
                height: 280px;
            }
        }
        
        /* Drag and Drop Styles */
        .drag-mode-active .timeline-item {
            cursor: grab;
            transition: all 0.2s ease;
        }
        
        .drag-mode-active .timeline-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .timeline-item.dragging {
            opacity: 0.6;
            transform: rotate(2deg) scale(1.05);
            cursor: grabbing;
            z-index: 1000;
            pointer-events: none;
        }
        
        .timeline-item.drag-over {
            border-top: 3px solid #5D5CDE;
            margin-top: 8px;
        }
        
        .drag-placeholder {
            height: 80px;
            border: 2px dashed #5D5CDE;
            border-radius: 8px;
            background: rgba(93, 92, 222, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5D5CDE;
            font-weight: 500;
            margin: 8px 0;
        }
        
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 1001;
            transform: rotate(2deg) scale(1.05);
            opacity: 0.8;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
    </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-center mb-2">Workout Timer Pro</h1>
            <p class="text-gray-600 dark:text-gray-400 text-center">Design and execute your perfect workout</p>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Timer Section -->
            <div class="space-y-6">
                <!-- Main Timer Display -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-3xl p-8 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-primary/10 to-transparent"></div>
                    <div class="relative z-10">
                        <!-- Current Exercise Info -->
                        <div class="mb-6">
                            <h2 class="text-xl font-semibold mb-2" id="currentExercise">Ready to Start</h2>
                            <div class="flex justify-center items-center space-x-4 text-sm text-gray-600 dark:text-gray-400">
                                <span id="currentRep">Rep 0 of 0</span>
                                <span id="currentPhase">Ready</span>
                            </div>
                        </div>

                        <!-- Circular Progress Timer -->
                        <div class="relative mx-auto mb-6" style="width: 200px; height: 200px;">
                            <svg class="progress-ring w-full h-full">
                                <circle cx="100" cy="100" r="90" fill="transparent" stroke="currentColor" stroke-width="4" class="text-gray-300 dark:text-gray-600"></circle>
                                <circle cx="100" cy="100" r="90" fill="transparent" stroke="currentColor" stroke-width="6" class="text-primary progress-ring-circle" stroke-dasharray="565.48" stroke-dashoffset="565.48" id="progressCircle"></circle>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="timer-display text-4xl font-bold" id="timerDisplay">00:00</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="timerLabel">Ready</div>
                                </div>
                            </div>
                        </div>

                        <!-- Control Buttons -->
                        <div class="flex justify-center space-x-4">
                            <button id="startBtn" class="bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-full font-semibold transition-all transform hover:scale-105">
                                Start Workout
                            </button>
                            <button id="pauseBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-8 py-3 rounded-full font-semibold transition-all transform hover:scale-105 hidden">
                                Pause
                            </button>
                            <button id="skipBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full font-semibold transition-all transform hover:scale-105 hidden">
                                Skip Rest
                            </button>
                            <button id="resetBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-full font-semibold transition-all transform hover:scale-105">
                                Reset Phase
                            </button>
                            <button id="fullscreenBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-full font-semibold transition-all transform hover:scale-105">
                                Dashboard
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Overall Progress -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Workout Progress</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span>Overall Progress</span>
                            <span id="overallProgress">0%</span>
                        </div>
                        <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-3">
                            <div class="bg-primary h-3 rounded-full transition-all duration-300" style="width: 0%" id="overallProgressBar"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
                            <span id="timeElapsed">00:00</span>
                            <span id="timeRemaining">00:00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workout Editor & Timeline -->
            <div class="space-y-6">
                <!-- Workout Editor -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Workout Editor</h3>
                    
                    <!-- Add Exercise Form -->
                    <div class="space-y-4 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input type="text" id="exerciseTitle" placeholder="Exercise name" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                            <input type="number" id="exerciseReps" placeholder="Reps" min="1" value="3" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Work Time (seconds)</label>
                                <input type="number" id="workTime" value="45" min="1" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Rest Time (seconds)</label>
                                <input type="number" id="restTime" value="105" min="0" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                        </div>
                        <button id="addExerciseBtn" class="w-full bg-primary hover:bg-primary-dark text-white py-3 rounded-lg font-semibold transition-all">
                            Add Exercise
                        </button>
                    </div>
                    
                    <!-- Save/Load Section -->
                    <div class="border-t pt-4 space-y-3">
                        <div class="flex space-x-3">
                            <button id="saveWorkoutBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition-all">
                                üíæ Save Workout
                            </button>
                            <button id="loadWorkoutBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition-all">
                                üìÅ Load Workout
                            </button>
                        </div>
                        <input type="file" id="fileInput" accept=".json" style="display: none;">
                    </div>
                </div>

                <!-- Quick Workout Templates -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-6">
                    <h3 class="text-lg font-semibold mb-4">Quick Start Templates</h3>
                    <div class="space-y-2">
                        <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" data-template="hiit">
                            <div class="font-medium">HIIT Workout</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">4 exercises, 30s work, 15s rest</div>
                        </button>
                        <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" data-template="tabata">
                            <div class="font-medium">Tabata</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">8 rounds, 20s work, 10s rest</div>
                        </button>
                        <button class="template-btn w-full text-left p-3 bg-white dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-all" data-template="strength">
                            <div class="font-medium">Strength Training</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">5 exercises, 60s work, 90s rest</div>
                        </button>
                    </div>
                </div>

                <!-- Workout Timeline -->
                <div class="bg-gray-50 dark:bg-gray-800 rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Workout Timeline</h3>
                        <button id="dragModeBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all transform hover:scale-105">
                            üéØ Drag Mode
                        </button>
                    </div>
                    <div id="dragModeIndicator" class="hidden bg-purple-100 dark:bg-purple-900 border border-purple-300 dark:border-purple-700 rounded-lg p-3 mb-4">
                        <div class="text-purple-700 dark:text-purple-300 text-sm">
                            üì± <strong>Drag Mode Active:</strong> Touch and drag exercises to reorder them
                        </div>
                    </div>
                    <div id="workoutTimeline" class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                            No exercises added yet. Add your first exercise above!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Dashboard Mode -->
    <div id="dashboardMode" class="dashboard-mode text-white">
        <div class="flex flex-col items-center justify-center w-full h-full p-8">
            <!-- Close Button -->
            <button id="closeDashboard" class="absolute top-6 right-6 text-white text-2xl hover:text-gray-300 transition-colors">
                ‚úï
            </button>
            
            <!-- Current Exercise Section -->
            <div class="text-center mb-8 floating-animation">
                <div class="mb-4">
                    <h1 class="text-6xl md:text-7xl font-bold mb-2" id="dashCurrentExercise">Ready to Start</h1>
                    <div class="text-2xl md:text-3xl text-white/80 mb-2" id="dashCurrentRep">Rep 0 of 0</div>
                    <div class="text-3xl md:text-4xl font-semibold glow-animation" id="dashCurrentPhase">Ready</div>
                </div>
            </div>

            <!-- Big Timer Circle -->
            <div class="relative mb-8 floating-animation">
                <div class="big-progress relative">
                    <svg class="progress-ring w-full h-full">
                        <circle cx="200" cy="200" r="180" fill="transparent" stroke="rgba(255,255,255,0.2)" stroke-width="8"></circle>
                        <circle cx="200" cy="200" r="180" fill="transparent" stroke="white" stroke-width="12" class="progress-ring-circle" stroke-dasharray="1130.97" stroke-dashoffset="1130.97" id="dashProgressCircle"></circle>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="text-center">
                            <div class="timer-display big-timer font-bold" id="dashTimerDisplay">00:00</div>
                            <div class="text-2xl md:text-3xl text-white/70 mt-4" id="dashTimerLabel">Ready</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Next Exercise Preview -->
            <div class="text-center mb-8" id="nextExerciseSection" style="display: none;">
                <div class="text-lg text-white/60 mb-2">Up Next:</div>
                <div class="text-2xl md:text-3xl font-semibold text-white/90" id="nextExerciseName">-</div>
                <div class="text-lg text-white/70" id="nextExerciseDetails">-</div>
            </div>

            <!-- Dashboard Controls -->
            <div class="flex flex-wrap justify-center gap-4">
                <button id="dashStartBtn" class="bg-white text-purple-600 px-8 py-4 rounded-full text-xl font-semibold hover:bg-gray-100 transition-all transform hover:scale-105">
                    Start Workout
                </button>
                <button id="dashPauseBtn" class="bg-gray-600 text-white px-8 py-4 rounded-full text-xl font-semibold hover:bg-gray-700 transition-all transform hover:scale-105 hidden">
                    Pause
                </button>
                <button id="dashResetBtn" class="bg-orange-600 text-white px-6 py-4 rounded-full text-xl font-semibold hover:bg-orange-700 transition-all transform hover:scale-105">
                    Reset Phase
                </button>
            </div>

            <!-- Overall Progress Bar -->
            <div class="w-full max-w-2xl mt-8">
                <div class="flex justify-between text-lg text-white/80 mb-2">
                    <span>Overall Progress</span>
                    <span id="dashOverallProgress">0%</span>
                </div>
                <div class="w-full bg-white/20 rounded-full h-4">
                    <div class="bg-white h-4 rounded-full transition-all duration-300" style="width: 0%" id="dashOverallProgressBar"></div>
                </div>
                <div class="flex justify-between text-sm text-white/60 mt-2">
                    <span id="dashTimeElapsed">00:00</span>
                    <span id="dashTimeRemaining">00:00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables to avoid scope issues
        var timer = null;
        var exercises = [];
        var currentExerciseIndex = 0;
        var currentRep = 0;
        var isWorkPhase = true;
        var timeRemaining = 0;
        var isRunning = false;
        var isPaused = false;
        var totalWorkoutTime = 0;
        var elapsedTime = 0;
        var timerInterval = null;
        var audioContext = null;

        // Dark mode detection
        try {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(event) {
                    if (event.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                });
            }
        } catch (e) {
            console.log('Dark mode detection failed');
        }

        // Initialize audio
        function initializeAudio() {
            try {
                var AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (AudioCtx) {
                    audioContext = new AudioCtx();
                }
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playBeep(frequency, duration) {
            if (!audioContext) return;
            
            try {
                var oscillator = audioContext.createOscillator();
                var gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency || 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + (duration || 200) / 1000);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + (duration || 200) / 1000);
            } catch (e) {
                console.log('Beep failed');
            }
        }

        function addExercise() {
            var title = document.getElementById('exerciseTitle').value.trim();
            var reps = parseInt(document.getElementById('exerciseReps').value) || 1;
            var workTime = parseInt(document.getElementById('workTime').value) || 45;
            var restTime = parseInt(document.getElementById('restTime').value) || 105;

            if (!title) {
                showAlert('Please enter an exercise name');
                return;
            }

            var exercise = { title: title, reps: reps, workTime: workTime, restTime: restTime };
            exercises.push(exercise);
            
            // Clear form
            document.getElementById('exerciseTitle').value = '';
            document.getElementById('exerciseReps').value = '3';
            document.getElementById('workTime').value = '45';
            document.getElementById('restTime').value = '105';
            
            updateTimeline();
            calculateTotalTime();
        }

        function updateTimeline() {
            var timeline = document.getElementById('workoutTimeline');
            
            if (exercises.length === 0) {
                timeline.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400 py-8">No exercises added yet. Add your first exercise above!</div>';
                return;
            }

            var html = '';
            for (var i = 0; i < exercises.length; i++) {
                var exercise = exercises[i];
                var isActive = isRunning && i === currentExerciseIndex;
                var isCompleted = isRunning && i < currentExerciseIndex;
                
                var borderClass = 'border-gray-300 dark:border-gray-600';
                if (isActive) borderClass = 'border-primary timeline-active';
                if (isCompleted) borderClass = 'border-green-500';
                
                var titleClass = isActive ? 'text-primary' : '';
                var statusHtml = isActive ? '<div class="text-xs text-primary mt-1 font-medium">Rep ' + (currentRep + 1) + ' of ' + exercise.reps + ' - ' + (isWorkPhase ? 'WORK' : 'REST') + '</div>' : '';
                
                html += '<div class="timeline-item bg-white dark:bg-gray-700 p-4 rounded-lg border-l-4 ' + borderClass + '" data-exercise-index="' + i + '">';
                html += '<div class="flex justify-between items-start">';
                html += '<div class="flex-1">';
                html += '<h4 class="font-semibold ' + titleClass + '">' + exercise.title + '</h4>';
                html += '<div class="text-sm text-gray-600 dark:text-gray-400 mt-1">' + exercise.reps + ' reps √ó ' + exercise.workTime + 's work / ' + exercise.restTime + 's rest</div>';
                html += statusHtml;
                html += '</div>';
                html += '<div class="flex flex-col space-y-1 ml-4">';
                html += '<div class="flex space-x-2">';
                html += '<button class="edit-exercise-btn text-blue-500 hover:text-blue-700 text-sm" data-index="' + i + '">Edit</button>';
                html += '<button class="delete-exercise-btn text-red-500 hover:text-red-700 text-sm" data-index="' + i + '">Delete</button>';
                html += '</div>';
                html += '<div class="flex space-x-1">';
                if (i > 0) {
                    html += '<button class="move-up-btn text-gray-500 hover:text-gray-700 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded" data-index="' + i + '">‚Üë</button>';
                }
                if (i < exercises.length - 1) {
                    html += '<button class="move-down-btn text-gray-500 hover:text-gray-700 text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded" data-index="' + i + '">‚Üì</button>';
                }
                html += '</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }
            
            timeline.innerHTML = html;
        }

        function calculateTotalTime() {
            totalWorkoutTime = 0;
            for (var i = 0; i < exercises.length; i++) {
                var exercise = exercises[i];
                totalWorkoutTime += exercise.reps * (exercise.workTime + exercise.restTime);
            }
            updateTimeDisplay();
        }

        function startWorkout() {
            if (exercises.length === 0) {
                showAlert('Please add at least one exercise to start the workout');
                return;
            }

            // Enable audio context if needed
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (isPaused) {
                isPaused = false;
            } else {
                currentExerciseIndex = 0;
                currentRep = 0;
                isWorkPhase = true;
                elapsedTime = 0;
                timeRemaining = exercises[0].workTime;
            }

            isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            
            updateDisplay();
            updateTimeline();
            startTimer();
        }

        function pauseWorkout() {
            isPaused = true;
            isRunning = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function resetCurrentPhase() {
            if (!isRunning && !isPaused) {
                // Full reset if not in a workout
                resetWorkout();
                return;
            }
            
            // Reset current phase only
            var currentExercise = exercises[currentExerciseIndex];
            if (currentExercise) {
                timeRemaining = isWorkPhase ? currentExercise.workTime : currentExercise.restTime;
                updateDisplay();
                updateDashboard();
            }
        }

        function resetWorkout() {
            isRunning = false;
            isPaused = false;
            currentExerciseIndex = 0;
            currentRep = 0;
            isWorkPhase = true;
            timeRemaining = 0;
            elapsedTime = 0;
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').textContent = 'Start Workout';
            
            // Update dashboard buttons
            document.getElementById('dashStartBtn').style.display = 'inline-block';
            document.getElementById('dashPauseBtn').style.display = 'none';
            document.getElementById('dashStartBtn').textContent = 'Start Workout';
            
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            updateDisplay();
            updateDashboard();
            updateTimeline();
        }

        function startTimer() {
            timerInterval = setInterval(function() {
                timeRemaining--;
                elapsedTime++;
                
                // Audio countdown for last 5 seconds
                if (timeRemaining <= 5 && timeRemaining > 0) {
                    playBeep(600, 150);
                }
                
                updateDisplay();
                updateDashboard();
                
                if (timeRemaining <= 0) {
                    playBeep(1000, 300); // End beep
                    nextPhase();
                }
            }, 1000);
        }

        function nextPhase() {
            var currentExercise = exercises[currentExerciseIndex];
            
            if (isWorkPhase) {
                // Switch to rest phase
                isWorkPhase = false;
                timeRemaining = currentExercise.restTime;
            } else {
                // Switch to next rep or exercise
                currentRep++;
                
                if (currentRep >= currentExercise.reps) {
                    // Move to next exercise
                    currentExerciseIndex++;
                    currentRep = 0;
                    
                    if (currentExerciseIndex >= exercises.length) {
                        // Workout complete
                        completeWorkout();
                        return;
                    }
                    
                    var nextExercise = exercises[currentExerciseIndex];
                    timeRemaining = nextExercise.workTime;
                } else {
                    // Next rep of same exercise
                    timeRemaining = currentExercise.workTime;
                }
                
                isWorkPhase = true;
            }
            
            updateDisplay();
            updateTimeline();
        }

        function completeWorkout() {
            isRunning = false;
            clearInterval(timerInterval);
            
            document.getElementById('currentExercise').textContent = 'Workout Complete!';
            document.getElementById('currentRep').textContent = 'Great job!';
            document.getElementById('currentPhase').textContent = 'Finished';
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('timerLabel').textContent = 'Complete';
            
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').textContent = 'Start New Workout';
            
            // Celebration beeps
            setTimeout(function() { playBeep(800, 200); }, 0);
            setTimeout(function() { playBeep(1000, 200); }, 200);
            setTimeout(function() { playBeep(1200, 300); }, 400);
            
            updateTimeline();
        }

        function updateDisplay() {
            if (exercises.length === 0) {
                document.getElementById('currentExercise').textContent = 'Ready to Start';
                document.getElementById('currentRep').textContent = 'Rep 0 of 0';
                document.getElementById('currentPhase').textContent = 'Ready';
                document.getElementById('timerDisplay').textContent = '00:00';
                document.getElementById('timerLabel').textContent = 'Ready';
                return;
            }

            var currentExercise = exercises[currentExerciseIndex];
            
            if (isRunning || isPaused) {
                document.getElementById('currentExercise').textContent = currentExercise.title;
                document.getElementById('currentRep').textContent = 'Rep ' + (currentRep + 1) + ' of ' + currentExercise.reps;
                document.getElementById('currentPhase').textContent = isWorkPhase ? 'WORK' : 'REST';
                document.getElementById('timerLabel').textContent = isWorkPhase ? 'Work Time' : 'Rest Time';
                
                // Update circular progress
                var totalTime = isWorkPhase ? currentExercise.workTime : currentExercise.restTime;
                var progress = ((totalTime - timeRemaining) / totalTime) * 100;
                var circumference = 2 * Math.PI * 90;
                var offset = circumference - (progress / 100 * circumference);
                document.getElementById('progressCircle').style.strokeDashoffset = offset;
                
                // Add pulse animation for last 5 seconds
                var timerDisplay = document.getElementById('timerDisplay');
                if (timeRemaining <= 5) {
                    timerDisplay.classList.add('pulse-animation');
                } else {
                    timerDisplay.classList.remove('pulse-animation');
                }
            }
            
            document.getElementById('timerDisplay').textContent = formatTime(timeRemaining);
            updateTimeDisplay();
            updateSkipButton();
        }

        function updateTimeDisplay() {
            var overallProgress = totalWorkoutTime > 0 ? (elapsedTime / totalWorkoutTime) * 100 : 0;
            document.getElementById('overallProgress').textContent = Math.round(overallProgress) + '%';
            document.getElementById('overallProgressBar').style.width = overallProgress + '%';
            
            document.getElementById('timeElapsed').textContent = formatTime(elapsedTime);
            document.getElementById('timeRemaining').textContent = formatTime(Math.max(0, totalWorkoutTime - elapsedTime));
        }

        function formatTime(seconds) {
            var mins = Math.floor(seconds / 60);
            var secs = seconds % 60;
            var minsStr = mins < 10 ? '0' + mins : mins;
            var secsStr = secs < 10 ? '0' + secs : secs;
            return minsStr + ':' + secsStr;
        }

        function showAlert(message) {
            var modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = '<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class="text-gray-700 dark:text-gray-300 mb-4">' + message + '</p><div class="flex justify-end"><button class="ok-btn px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded">OK</button></div></div>';
            document.body.appendChild(modal);
            
            modal.querySelector('.ok-btn').addEventListener('click', function() {
                modal.remove();
            });
        }

        function showConfirmDialog(message, onConfirm) {
            var modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = '<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4"><p class="text-gray-700 dark:text-gray-300 mb-4">' + message + '</p><div class="flex justify-end space-x-3"><button class="cancel-btn px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button><button class="confirm-btn px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded">Confirm</button></div></div>';
            document.body.appendChild(modal);
            
            modal.querySelector('.cancel-btn').addEventListener('click', function() {
                modal.remove();
            });
            
            modal.querySelector('.confirm-btn').addEventListener('click', function() {
                modal.remove();
                onConfirm();
            });
        }

        function deleteExercise(index) {
            showConfirmDialog('Are you sure you want to delete this exercise?', function() {
                exercises.splice(index, 1);
                updateTimeline();
                calculateTotalTime();
                
                // Adjust current exercise index if needed
                if (currentExerciseIndex >= exercises.length) {
                    currentExerciseIndex = Math.max(0, exercises.length - 1);
                }
            });
        }

        function editExercise(index) {
            var exercise = exercises[index];
            if (!exercise) return;

            // Create inline edit form
            var timelineItem = document.querySelector('[data-exercise-index="' + index + '"]');
            var originalContent = timelineItem.innerHTML;
            
            timelineItem.innerHTML = '<div class="space-y-2">' +
                '<input type="text" value="' + exercise.title + '" class="w-full px-3 py-2 text-sm border rounded edit-title">' +
                '<div class="grid grid-cols-3 gap-2">' +
                    '<input type="number" value="' + exercise.reps + '" min="1" class="px-2 py-1 text-sm border rounded edit-reps" placeholder="Reps">' +
                    '<input type="number" value="' + exercise.workTime + '" min="1" class="px-2 py-1 text-sm border rounded edit-work" placeholder="Work">' +
                    '<input type="number" value="' + exercise.restTime + '" min="0" class="px-2 py-1 text-sm border rounded edit-rest" placeholder="Rest">' +
                '</div>' +
                '<div class="flex space-x-2">' +
                    '<button class="save-edit-btn bg-green-500 text-white px-3 py-1 rounded text-sm">Save</button>' +
                    '<button class="cancel-edit-btn bg-gray-500 text-white px-3 py-1 rounded text-sm">Cancel</button>' +
                '</div>' +
            '</div>';

            var saveBtn = timelineItem.querySelector('.save-edit-btn');
            var cancelBtn = timelineItem.querySelector('.cancel-edit-btn');

            saveBtn.addEventListener('click', function() {
                var newTitle = timelineItem.querySelector('.edit-title').value.trim();
                var newReps = parseInt(timelineItem.querySelector('.edit-reps').value);
                var newWork = parseInt(timelineItem.querySelector('.edit-work').value);
                var newRest = parseInt(timelineItem.querySelector('.edit-rest').value);

                if (newTitle && newReps > 0 && newWork > 0 && newRest >= 0) {
                    exercises[index] = {
                        title: newTitle,
                        reps: newReps,
                        workTime: newWork,
                        restTime: newRest
                    };
                    updateTimeline();
                    calculateTotalTime();
                }
            });

            cancelBtn.addEventListener('click', function() {
                timelineItem.innerHTML = originalContent;
            });
        }

        function moveExercise(index, direction) {
            if (index + direction < 0 || index + direction >= exercises.length) return;
            
            // Swap exercises
            var temp = exercises[index];
            exercises[index] = exercises[index + direction];
            exercises[index + direction] = temp;
            
            // Adjust current exercise index if needed
            if (currentExerciseIndex === index) {
                currentExerciseIndex = index + direction;
            } else if (currentExerciseIndex === index + direction) {
                currentExerciseIndex = index;
            }
            
            updateTimeline();
        }

        function toggleDashboard() {
            var dashboard = document.getElementById('dashboardMode');
            dashboard.classList.add('active');
            updateDashboard();
        }

        function closeDashboard() {
            var dashboard = document.getElementById('dashboardMode');
            dashboard.classList.remove('active');
        }

        function updateDashboard() {
            // Update current exercise info
            if (exercises.length === 0) {
                document.getElementById('dashCurrentExercise').textContent = 'Ready to Start';
                document.getElementById('dashCurrentRep').textContent = 'Rep 0 of 0';
                document.getElementById('dashCurrentPhase').textContent = 'Ready';
                document.getElementById('dashTimerDisplay').textContent = '00:00';
                document.getElementById('dashTimerLabel').textContent = 'Ready';
                document.getElementById('nextExerciseSection').style.display = 'none';
                return;
            }

            var currentExercise = exercises[currentExerciseIndex];
            
            if (isRunning || isPaused) {
                document.getElementById('dashCurrentExercise').textContent = currentExercise.title;
                document.getElementById('dashCurrentRep').textContent = 'Rep ' + (currentRep + 1) + ' of ' + currentExercise.reps;
                document.getElementById('dashCurrentPhase').textContent = isWorkPhase ? 'WORK' : 'REST';
                document.getElementById('dashTimerLabel').textContent = isWorkPhase ? 'Work Time' : 'Rest Time';
                
                // Update next exercise preview
                var nextExerciseIndex = currentExerciseIndex;
                var nextRep = currentRep;
                var nextIsWork = isWorkPhase;
                
                // Calculate next phase
                if (nextIsWork) {
                    nextIsWork = false; // Next will be rest
                } else {
                    nextRep++;
                    if (nextRep >= currentExercise.reps) {
                        nextExerciseIndex++;
                        nextRep = 0;
                    }
                    nextIsWork = true; // Next will be work
                }
                
                var nextExerciseSection = document.getElementById('nextExerciseSection');
                if (nextExerciseIndex < exercises.length) {
                    var nextExercise = exercises[nextExerciseIndex];
                    document.getElementById('nextExerciseName').textContent = nextExercise.title;
                    document.getElementById('nextExerciseDetails').textContent = 
                        'Rep ' + (nextRep + 1) + ' of ' + nextExercise.reps + ' - ' + (nextIsWork ? 'WORK' : 'REST');
                    nextExerciseSection.style.display = 'block';
                } else {
                    nextExerciseSection.style.display = 'none';
                }
                
                // Update big circular progress
                var totalTime = isWorkPhase ? currentExercise.workTime : currentExercise.restTime;
                var progress = ((totalTime - timeRemaining) / totalTime) * 100;
                var circumference = 2 * Math.PI * 180;
                var offset = circumference - (progress / 100 * circumference);
                document.getElementById('dashProgressCircle').style.strokeDashoffset = offset;
                
                // Update button states
                document.getElementById('dashStartBtn').style.display = 'none';
                document.getElementById('dashPauseBtn').style.display = 'inline-block';
                
                // Add pulse animation for last 5 seconds
                var dashTimerDisplay = document.getElementById('dashTimerDisplay');
                if (timeRemaining <= 5) {
                    dashTimerDisplay.classList.add('pulse-animation');
                } else {
                    dashTimerDisplay.classList.remove('pulse-animation');
                }
            } else {
                document.getElementById('dashCurrentExercise').textContent = currentExercise ? currentExercise.title : 'Ready to Start';
                document.getElementById('dashCurrentRep').textContent = 'Rep 0 of 0';
                document.getElementById('dashCurrentPhase').textContent = 'Ready';
                document.getElementById('dashTimerLabel').textContent = 'Ready';
                document.getElementById('nextExerciseSection').style.display = 'none';
                
                document.getElementById('dashStartBtn').style.display = 'inline-block';
                document.getElementById('dashPauseBtn').style.display = 'none';
            }
            
            document.getElementById('dashTimerDisplay').textContent = formatTime(timeRemaining);
            
            // Update overall progress in dashboard
            var overallProgress = totalWorkoutTime > 0 ? (elapsedTime / totalWorkoutTime) * 100 : 0;
            document.getElementById('dashOverallProgress').textContent = Math.round(overallProgress) + '%';
            document.getElementById('dashOverallProgressBar').style.width = overallProgress + '%';
            
            document.getElementById('dashTimeElapsed').textContent = formatTime(elapsedTime);
            document.getElementById('dashTimeRemaining').textContent = formatTime(Math.max(0, totalWorkoutTime - elapsedTime));
        }

        function skipRest() {
            if (!isRunning || isWorkPhase) return;
            
            // Skip rest and go to next work phase
            nextPhase();
        }

        function saveWorkout() {
            if (exercises.length === 0) {
                showAlert('No exercises to save! Add some exercises first.');
                return;
            }

            var workoutData = {
                name: 'My Workout - ' + new Date().toLocaleDateString(),
                exercises: exercises,
                created: new Date().toISOString()
            };

            var dataStr = JSON.stringify(workoutData, null, 2);
            var dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            var link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'workout-' + new Date().toISOString().split('T')[0] + '.json';
            link.click();
            
            showAlert('Workout saved successfully!');
        }

        function loadWorkout() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var workoutData = JSON.parse(e.target.result);
                    
                    if (workoutData.exercises && Array.isArray(workoutData.exercises)) {
                        exercises = workoutData.exercises;
                        updateTimeline();
                        calculateTotalTime();
                        showAlert('Workout loaded successfully!');
                    } else {
                        showAlert('Invalid workout file format.');
                    }
                } catch (error) {
                    showAlert('Error loading workout file.');
                }
            };
            reader.readAsText(file);
        }

        function loadTemplate(templateType) {
            var templateExercises = [];
            
            switch(templateType) {
                case 'hiit':
                    templateExercises = [
                        { title: 'Jumping Jacks', reps: 3, workTime: 30, restTime: 15 },
                        { title: 'High Knees', reps: 3, workTime: 30, restTime: 15 },
                        { title: 'Burpees', reps: 3, workTime: 30, restTime: 15 },
                        { title: 'Mountain Climbers', reps: 3, workTime: 30, restTime: 15 }
                    ];
                    break;
                case 'tabata':
                    templateExercises = [
                        { title: 'Squats', reps: 8, workTime: 20, restTime: 10 }
                    ];
                    break;
                case 'strength':
                    templateExercises = [
                        { title: 'Push-ups', reps: 3, workTime: 60, restTime: 90 },
                        { title: 'Squats', reps: 3, workTime: 60, restTime: 90 },
                        { title: 'Lunges', reps: 3, workTime: 60, restTime: 90 },
                        { title: 'Plank', reps: 3, workTime: 60, restTime: 90 },
                        { title: 'Deadlifts', reps: 3, workTime: 60, restTime: 90 }
                    ];
                    break;
            }
            
            if (exercises.length > 0) {
                showConfirmDialog('This will replace your current workout. Continue?', function() {
                    exercises = templateExercises;
                    updateTimeline();
                    calculateTotalTime();
                });
            } else {
                exercises = templateExercises;
                updateTimeline();
                calculateTotalTime();
            }
        }

        function updateSkipButton() {
            var skipBtn = document.getElementById('skipBtn');
            
            // Show skip button only during rest periods
            if (isRunning && !isWorkPhase) {
                skipBtn.style.display = 'inline-block';
            } else {
                skipBtn.style.display = 'none';
            }
        }

        // Drag and Drop Variables
        var isDragModeActive = false;
        var draggedItem = null;
        var draggedIndex = -1;
        var dragGhost = null;
        var touchStartY = 0;
        var dragThreshold = 10;

        function toggleDragMode() {
            isDragModeActive = !isDragModeActive;
            var dragModeBtn = document.getElementById('dragModeBtn');
            var dragModeIndicator = document.getElementById('dragModeIndicator');
            var timeline = document.getElementById('workoutTimeline');
            
            if (isDragModeActive) {
                dragModeBtn.textContent = '‚úì Drag Active';
                dragModeBtn.classList.remove('bg-purple-500', 'hover:bg-purple-600');
                dragModeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                dragModeIndicator.classList.remove('hidden');
                timeline.classList.add('drag-mode-active');
                enableDragAndDrop();
            } else {
                dragModeBtn.textContent = 'üéØ Drag Mode';
                dragModeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                dragModeBtn.classList.add('bg-purple-500', 'hover:bg-purple-600');
                dragModeIndicator.classList.add('hidden');
                timeline.classList.remove('drag-mode-active');
                disableDragAndDrop();
            }
        }

        function enableDragAndDrop() {
            var timeline = document.getElementById('workoutTimeline');
            timeline.addEventListener('touchstart', handleTouchStart, { passive: false });
            timeline.addEventListener('touchmove', handleTouchMove, { passive: false });
            timeline.addEventListener('touchend', handleTouchEnd, { passive: false });
            timeline.addEventListener('mousedown', handleMouseDown);
            timeline.addEventListener('mousemove', handleMouseMove);
            timeline.addEventListener('mouseup', handleMouseEnd);
        }

        function disableDragAndDrop() {
            var timeline = document.getElementById('workoutTimeline');
            timeline.removeEventListener('touchstart', handleTouchStart);
            timeline.removeEventListener('touchmove', handleTouchMove);
            timeline.removeEventListener('touchend', handleTouchEnd);
            timeline.removeEventListener('mousedown', handleMouseDown);
            timeline.removeEventListener('mousemove', handleMouseMove);
            timeline.removeEventListener('mouseup', handleMouseEnd);
            
            cleanupDrag();
        }

        function handleTouchStart(e) {
            if (!isDragModeActive) return;
            
            var touch = e.touches[0];
            var timelineItem = touch.target.closest('.timeline-item');
            if (!timelineItem) return;
            
            touchStartY = touch.clientY;
            draggedItem = timelineItem;
            draggedIndex = parseInt(timelineItem.getAttribute('data-exercise-index'));
            
            // Prevent scrolling while dragging
            e.preventDefault();
        }

        function handleTouchMove(e) {
            if (!draggedItem) return;
            
            var touch = e.touches[0];
            var deltaY = Math.abs(touch.clientY - touchStartY);
            
            if (deltaY > dragThreshold && !dragGhost) {
                startDrag(touch.clientX, touch.clientY);
            }
            
            if (dragGhost) {
                updateDragPosition(touch.clientX, touch.clientY);
                updateDropIndicator(touch.clientX, touch.clientY);
            }
            
            e.preventDefault();
        }

        function handleTouchEnd(e) {
            if (dragGhost) {
                var touch = e.changedTouches[0];
                finishDrag(touch.clientX, touch.clientY);
            }
            cleanupDrag();
        }

        function handleMouseDown(e) {
            if (!isDragModeActive) return;
            
            var timelineItem = e.target.closest('.timeline-item');
            if (!timelineItem) return;
            
            draggedItem = timelineItem;
            draggedIndex = parseInt(timelineItem.getAttribute('data-exercise-index'));
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseEnd);
            
            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (!draggedItem) return;
            
            if (!dragGhost) {
                startDrag(e.clientX, e.clientY);
            }
            
            if (dragGhost) {
                updateDragPosition(e.clientX, e.clientY);
                updateDropIndicator(e.clientX, e.clientY);
            }
        }

        function handleMouseEnd(e) {
            if (dragGhost) {
                finishDrag(e.clientX, e.clientY);
            }
            cleanupDrag();
            
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseEnd);
        }

        function startDrag(clientX, clientY) {
            if (!draggedItem) return;
            
            // Create visual feedback
            draggedItem.classList.add('dragging');
            
            // Create drag ghost
            dragGhost = draggedItem.cloneNode(true);
            dragGhost.classList.remove('dragging');
            dragGhost.classList.add('drag-ghost');
            dragGhost.style.width = draggedItem.offsetWidth + 'px';
            dragGhost.style.left = clientX - (draggedItem.offsetWidth / 2) + 'px';
            dragGhost.style.top = clientY - 40 + 'px';
            document.body.appendChild(dragGhost);
            
            // Create placeholder
            var placeholder = document.createElement('div');
            placeholder.className = 'drag-placeholder';
            placeholder.textContent = 'üìç Drop here';
            placeholder.id = 'dragPlaceholder';
            draggedItem.parentNode.insertBefore(placeholder, draggedItem.nextSibling);
        }

        function updateDragPosition(clientX, clientY) {
            if (dragGhost) {
                dragGhost.style.left = clientX - (dragGhost.offsetWidth / 2) + 'px';
                dragGhost.style.top = clientY - 40 + 'px';
            }
        }

        function updateDropIndicator(clientX, clientY) {
            var timeline = document.getElementById('workoutTimeline');
            var items = timeline.querySelectorAll('.timeline-item:not(.dragging)');
            var closestItem = null;
            var closestDistance = Infinity;
            var insertBefore = true;
            
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var rect = item.getBoundingClientRect();
                var centerY = rect.top + rect.height / 2;
                var distance = Math.abs(clientY - centerY);
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestItem = item;
                    insertBefore = clientY < centerY;
                }
            }
            
            // Remove existing indicators
            var existingIndicators = timeline.querySelectorAll('.drag-over');
            for (var i = 0; i < existingIndicators.length; i++) {
                existingIndicators[i].classList.remove('drag-over');
            }
            
            if (closestItem && closestDistance < 100) {
                closestItem.classList.add('drag-over');
            }
        }

        function finishDrag(clientX, clientY) {
            var timeline = document.getElementById('workoutTimeline');
            var items = timeline.querySelectorAll('.timeline-item:not(.dragging)');
            var targetIndex = draggedIndex;
            
            // Find drop target
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var rect = item.getBoundingClientRect();
                var centerY = rect.top + rect.height / 2;
                
                if (Math.abs(clientY - centerY) < 100) {
                    var itemIndex = parseInt(item.getAttribute('data-exercise-index'));
                    targetIndex = clientY < centerY ? itemIndex : itemIndex + 1;
                    break;
                }
            }
            
            // Perform the move
            if (targetIndex !== draggedIndex && targetIndex !== draggedIndex + 1) {
                moveExerciseToPosition(draggedIndex, targetIndex);
            }
        }

        function moveExerciseToPosition(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;
            
            // Remove item from array
            var movedExercise = exercises.splice(fromIndex, 1)[0];
            
            // Adjust target index if we removed an item before it
            if (fromIndex < toIndex) {
                toIndex--;
            }
            
            // Insert at new position
            exercises.splice(toIndex, 0, movedExercise);
            
            // Adjust current exercise index if needed
            if (currentExerciseIndex === fromIndex) {
                currentExerciseIndex = toIndex;
            } else if (fromIndex < currentExerciseIndex && toIndex >= currentExerciseIndex) {
                currentExerciseIndex--;
            } else if (fromIndex > currentExerciseIndex && toIndex <= currentExerciseIndex) {
                currentExerciseIndex++;
            }
            
            updateTimeline();
            
            // Show feedback
            showAlert('Exercise moved successfully!');
        }

        function cleanupDrag() {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
            
            if (dragGhost) {
                document.body.removeChild(dragGhost);
                dragGhost = null;
            }
            
            var placeholder = document.getElementById('dragPlaceholder');
            if (placeholder) {
                placeholder.parentNode.removeChild(placeholder);
            }
            
            var timeline = document.getElementById('workoutTimeline');
            var dragOverItems = timeline.querySelectorAll('.drag-over');
            for (var i = 0; i < dragOverItems.length; i++) {
                dragOverItems[i].classList.remove('drag-over');
            }
            
            draggedIndex = -1;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeAudio();
            
            // Bind event listeners
            document.getElementById('startBtn').addEventListener('click', startWorkout);
            document.getElementById('pauseBtn').addEventListener('click', pauseWorkout);
            document.getElementById('resetBtn').addEventListener('click', resetCurrentPhase);
            document.getElementById('skipBtn').addEventListener('click', skipRest);
            document.getElementById('addExerciseBtn').addEventListener('click', addExercise);
            document.getElementById('fullscreenBtn').addEventListener('click', toggleDashboard);
            document.getElementById('closeDashboard').addEventListener('click', closeDashboard);
            document.getElementById('saveWorkoutBtn').addEventListener('click', saveWorkout);
            document.getElementById('loadWorkoutBtn').addEventListener('click', loadWorkout);
            document.getElementById('fileInput').addEventListener('change', handleFileLoad);
            document.getElementById('dragModeBtn').addEventListener('click', toggleDragMode);
            
            // Dashboard buttons
            document.getElementById('dashStartBtn').addEventListener('click', startWorkout);
            document.getElementById('dashPauseBtn').addEventListener('click', pauseWorkout);
            document.getElementById('dashResetBtn').addEventListener('click', resetCurrentPhase);
            
            // Event delegation for dynamic buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-exercise-btn')) {
                    var index = parseInt(e.target.getAttribute('data-index'));
                    deleteExercise(index);
                }
                if (e.target.classList.contains('edit-exercise-btn')) {
                    var index = parseInt(e.target.getAttribute('data-index'));
                    editExercise(index);
                }
                if (e.target.classList.contains('move-up-btn')) {
                    var index = parseInt(e.target.getAttribute('data-index'));
                    moveExercise(index, -1);
                }
                if (e.target.classList.contains('move-down-btn')) {
                    var index = parseInt(e.target.getAttribute('data-index'));
                    moveExercise(index, 1);
                }
                if (e.target.classList.contains('template-btn')) {
                    var template = e.target.getAttribute('data-template');
                    loadTemplate(template);
                }
            });
            
            // Initialize display
            updateDisplay();
            updateDashboard();
            updateTimeline();
        });
    </script>


</body></html>
