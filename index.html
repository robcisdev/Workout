<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BabyTrack Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
            --accent-pink: #ff6b9d;
            --accent-blue: #4facfe;
            --accent-purple: #a855f7;
            --accent-green: #10b981;
            --accent-yellow: #fbbf24;
            --accent-orange: #f97316;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #2d3a52;
        }

        .dark {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: #1a2235;
        }

        html:not(.dark) {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
        }

        * {
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .dark body {
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 50%, #0f172a 100%);
        }

        .widget-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dark .widget-card {
            background: linear-gradient(145deg, rgba(26, 34, 53, 0.9), rgba(17, 24, 39, 0.95));
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .widget-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-blue));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .widget-card:hover::before {
            opacity: 1;
        }

        .stat-card {
            position: relative;
        }

        .stat-card .icon-bg {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .feeding-icon { background: linear-gradient(135deg, #ff6b9d, #ff8fab); }
        .pumping-icon { background: linear-gradient(135deg, #a855f7, #c084fc); }
        .wet-icon { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .dirty-icon { background: linear-gradient(135deg, #f97316, #fbbf24); }
        .medical-icon { background: linear-gradient(135deg, #10b981, #34d399); }

        .glow-pink { box-shadow: 0 4px 20px rgba(255, 107, 157, 0.3); }
        .glow-purple { box-shadow: 0 4px 20px rgba(168, 85, 247, 0.3); }
        .glow-blue { box-shadow: 0 4px 20px rgba(79, 172, 254, 0.3); }
        .glow-orange { box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3); }
        .glow-green { box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3); }

        .nav-tab {
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .nav-tab:hover {
            background: rgba(255, 107, 157, 0.1);
            color: var(--accent-pink);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b9d, #ff8fab);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b9d, #ff8fab);
            color: white;
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
        }

        .btn-secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-secondary:hover {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .input-field {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 18px;
            color: var(--text-primary);
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-pink);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .history-row {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s;
        }

        .history-row:hover {
            border-color: var(--accent-pink);
            transform: translateX(4px);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-feeding { background: rgba(255, 107, 157, 0.2); color: #ff6b9d; }
        .badge-pumping { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .badge-wet { background: rgba(79, 172, 254, 0.2); color: #4facfe; }
        .badge-dirty { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .badge-medical { background: rgba(16, 185, 129, 0.2); color: #10b981; }

        .chart-container {
            position: relative;
            height: 250px;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .toggle-btn {
            width: 52px;
            height: 28px;
            background: var(--border-color);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #ff6b9d, #ff8fab);
        }

        .toggle-btn::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        .toggle-btn.active::after {
            transform: translateX(24px);
        }

        .quick-action {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .quick-action:hover {
            transform: scale(1.05);
        }

        .quick-action.feeding { background: linear-gradient(135deg, rgba(255, 107, 157, 0.2), rgba(255, 143, 171, 0.1)); border-color: #ff6b9d; }
        .quick-action.pumping { background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(192, 132, 252, 0.1)); border-color: #a855f7; }
        .quick-action.wet { background: linear-gradient(135deg, rgba(79, 172, 254, 0.2), rgba(0, 242, 254, 0.1)); border-color: #4facfe; }
        .quick-action.dirty { background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(251, 191, 36, 0.1)); border-color: #f97316; }
        .quick-action.medical { background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(52, 211, 153, 0.1)); border-color: #10b981; }

        .duration-preset {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
        }

        .duration-preset:hover {
            border-color: var(--accent-pink);
            color: var(--accent-pink);
            background: rgba(255, 107, 157, 0.1);
        }

        .duration-preset.active {
            background: linear-gradient(135deg, #ff6b9d, #ff8fab);
            color: white;
            border-color: transparent;
        }

        .status-green {
            color: #10b981 !important;
        }

        .status-red {
            color: #ef4444 !important;
        }

        .dot-green {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }

        .dot-red {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
            animation: pulse-red 2s infinite;
        }

        .dot-gray {
            background: var(--text-secondary);
        }

        @keyframes pulse-red {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .live-timer {
            animation: pulse-green 1.5s infinite;
        }

        @keyframes pulse-green {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .stop-session-btn {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .stop-session-btn:hover {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .delete-btn {
            opacity: 0;
            transition: opacity 0.3s;
        }

        .history-row:hover .delete-btn {
            opacity: 1;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slide {
            animation: slideIn 0.4s ease forwards;
        }

        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }
        .stagger-4 { animation-delay: 0.4s; opacity: 0; }
    </style>
</head>
<body class="p-4 md:p-6 scrollbar-thin">
    <!-- Unsaved Changes Warning Banner -->
    <div id="unsaved-warning" class="hidden fixed top-0 left-0 right-0 z-50 px-4 py-3 flex items-center justify-center gap-3 flex-wrap" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
        <i class="fas fa-exclamation-triangle text-white"></i>
        <span class="text-white text-sm font-medium">You have unsaved changes!</span>
        <button onclick="exportData()" class="px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-white text-sm font-medium transition-colors">
            <i class="fas fa-save mr-1"></i>Save Now
        </button>
        <button onclick="dismissUnsavedWarning()" class="p-1 hover:bg-white/20 rounded-lg text-white transition-colors" title="Dismiss">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4" id="main-header">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-pink-500 to-purple-500 flex items-center justify-center">
                <i class="fas fa-baby text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-pink-400 to-purple-400 bg-clip-text text-transparent" style="font-family: 'Space Grotesk', sans-serif;">
                    BabyTrack Pro
                </h1>
                <div class="flex items-center gap-2 mt-1">
                    <div id="last-updated-dot" class="w-2 h-2 rounded-full"></div>
                    <p class="text-sm" id="last-updated-text" style="color: var(--text-secondary);">No records yet</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="exportData()" class="btn-secondary flex items-center gap-2">
                <i class="fas fa-download"></i>
                <span class="hidden sm:inline">Export</span>
            </button>
            <label class="btn-secondary flex items-center gap-2 cursor-pointer">
                <i class="fas fa-upload"></i>
                <span class="hidden sm:inline">Import</span>
                <input type="file" accept=".json" onchange="importData(event)" class="hidden">
            </label>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="flex flex-wrap gap-2 mb-8 p-2 rounded-2xl" style="background: var(--bg-card);">
        <div class="nav-tab active" data-tab="dashboard" onclick="switchTab('dashboard')">
            <i class="fas fa-th-large mr-2"></i>Dashboard
        </div>
        <div class="nav-tab" data-tab="add" onclick="switchTab('add')">
            <i class="fas fa-plus mr-2"></i>Add Record
        </div>
        <div class="nav-tab" data-tab="history" onclick="switchTab('history')">
            <i class="fas fa-history mr-2"></i>History
        </div>
        <div class="nav-tab" data-tab="analytics" onclick="switchTab('analytics')">
            <i class="fas fa-chart-line mr-2"></i>Analytics
        </div>
    </nav>

    <!-- Dashboard Tab -->
    <section id="tab-dashboard" class="tab-content">
        <!-- Quick Actions -->
        <div class="widget-card p-6 mb-6 animate-slide stagger-1">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-bolt text-yellow-400"></i>
                Quick Add
            </h3>
            <div class="flex flex-wrap gap-4 justify-center sm:justify-start">
                <div class="quick-action feeding" onclick="quickAdd('feeding')">
                    <i class="fas fa-baby-carriage text-2xl" style="color: #ff6b9d;"></i>
                    <span class="text-xs mt-1 font-medium" style="color: #ff6b9d;">Feed</span>
                </div>
                <div class="quick-action pumping" onclick="quickAdd('pumping')">
                    <i class="fas fa-prescription-bottle text-2xl" style="color: #a855f7;"></i>
                    <span class="text-xs mt-1 font-medium" style="color: #a855f7;">Pump</span>
                </div>
                <div class="quick-action wet" onclick="quickAdd('wet')">
                    <i class="fas fa-tint text-2xl" style="color: #4facfe;"></i>
                    <span class="text-xs mt-1 font-medium" style="color: #4facfe;">Wet</span>
                </div>
                <div class="quick-action dirty" onclick="quickAdd('dirty')">
                    <i class="fas fa-poo text-2xl" style="color: #f97316;"></i>
                    <span class="text-xs mt-1 font-medium" style="color: #f97316;">Dirty</span>
                </div>
                <div class="quick-action medical" onclick="openMedicalModal()">
                    <i class="fas fa-notes-medical text-2xl" style="color: #10b981;"></i>
                    <span class="text-xs mt-1 font-medium" style="color: #10b981;">Medical</span>
                </div>
            </div>
        </div>

        <!-- Last Feeding Alert -->
        <div id="last-feeding-alert" class="widget-card p-4 mb-6 animate-slide stagger-1">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, #ff6b9d, #ff8fab);">
                        <i class="fas fa-baby-carriage text-white text-xl"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Last Feeding</p>
                        <p class="text-xl font-bold" id="last-feeding-time">No feedings yet</p>
                    </div>
                </div>
                <div id="last-feeding-details" class="flex flex-wrap items-center gap-2 text-sm">
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
            <div class="widget-card stat-card p-5 animate-slide stagger-1">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm mb-1" style="color: var(--text-secondary);">Today's Feedings</p>
                        <h2 class="text-3xl font-bold" id="stat-feeding">0</h2>
                        <p class="text-xs mt-2" style="color: var(--text-secondary);">
                            <span id="feeding-duration">0</span> min total
                        </p>
                    </div>
                    <div class="icon-bg feeding-icon glow-pink">
                        <i class="fas fa-baby-carriage text-white"></i>
                    </div>
                </div>
            </div>

            <div class="widget-card stat-card p-5 animate-slide stagger-2">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm mb-1" style="color: var(--text-secondary);">Pumping Sessions</p>
                        <h2 class="text-3xl font-bold" id="stat-pumping">0</h2>
                        <p class="text-xs mt-2" style="color: var(--text-secondary);">
                            <span id="pumping-duration">0</span> min total
                        </p>
                    </div>
                    <div class="icon-bg pumping-icon glow-purple">
                        <i class="fas fa-prescription-bottle text-white"></i>
                    </div>
                </div>
            </div>

            <div class="widget-card stat-card p-5 animate-slide stagger-3">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm mb-1" style="color: var(--text-secondary);">Wet Diapers</p>
                        <h2 class="text-3xl font-bold" id="stat-wet">0</h2>
                        <p class="text-xs mt-2 flex items-center gap-1" style="color: var(--accent-green);">
                            <i class="fas fa-check-circle"></i> Healthy
                        </p>
                    </div>
                    <div class="icon-bg wet-icon glow-blue">
                        <i class="fas fa-tint text-white"></i>
                    </div>
                </div>
            </div>

            <div class="widget-card stat-card p-5 animate-slide stagger-4">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm mb-1" style="color: var(--text-secondary);">Dirty Diapers</p>
                        <h2 class="text-3xl font-bold" id="stat-dirty">0</h2>
                        <p class="text-xs mt-2 flex items-center gap-1" style="color: var(--accent-green);">
                            <i class="fas fa-check-circle"></i> Normal
                        </p>
                    </div>
                    <div class="icon-bg dirty-icon glow-orange">
                        <i class="fas fa-poo text-white"></i>
                    </div>
                </div>
            </div>

            <div class="widget-card stat-card p-5 animate-slide stagger-4 col-span-2 lg:col-span-1">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-sm mb-1" style="color: var(--text-secondary);">Medical Records</p>
                        <h2 class="text-3xl font-bold" id="stat-medical">0</h2>
                        <p class="text-xs mt-2" style="color: var(--text-secondary);">
                            <span id="last-medical">No records</span>
                        </p>
                    </div>
                    <div class="icon-bg medical-icon glow-green">
                        <i class="fas fa-notes-medical text-white"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="widget-card p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold">Recent Activity</h3>
                <button onclick="switchTab('history')" class="text-sm" style="color: var(--accent-pink);">View All</button>
            </div>
            <div id="recent-activity" class="space-y-3 max-h-72 overflow-y-auto scrollbar-thin">
                <p class="text-center py-8" style="color: var(--text-secondary);">No records yet. Start tracking!</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid md:grid-cols-2 gap-6">
            <div class="widget-card p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold">Activity Overview</h3>
                    <div class="flex items-center gap-2">
                        <div class="pulse-dot" style="background: var(--accent-pink);"></div>
                        <span class="text-xs" style="color: var(--text-secondary);">Live</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="widget-card p-6">
                <h3 class="font-semibold mb-4">Distribution</h3>
                <div class="chart-container">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Record Tab -->
    <section id="tab-add" class="tab-content hidden">
        <div class="widget-card p-6 max-w-2xl mx-auto">
            <h3 class="text-xl font-semibold mb-6 flex items-center gap-2">
                <i class="fas fa-plus-circle" style="color: var(--accent-pink);"></i>
                New Record
            </h3>

            <form id="add-form" onsubmit="addRecord(event)">
                <div class="grid gap-6">
                    <!-- Record Type -->
                    <div>
                        <label class="block text-sm font-medium mb-3">Record Type</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="type" value="feeding" class="hidden peer" required>
                                <div class="quick-action feeding w-full h-20 peer-checked:ring-2 peer-checked:ring-pink-400">
                                    <i class="fas fa-baby-carriage text-xl" style="color: #ff6b9d;"></i>
                                    <span class="text-xs mt-1" style="color: #ff6b9d;">Feeding</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="type" value="pumping" class="hidden peer">
                                <div class="quick-action pumping w-full h-20 peer-checked:ring-2 peer-checked:ring-purple-400">
                                    <i class="fas fa-prescription-bottle text-xl" style="color: #a855f7;"></i>
                                    <span class="text-xs mt-1" style="color: #a855f7;">Pumping</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="type" value="wet" class="hidden peer">
                                <div class="quick-action wet w-full h-20 peer-checked:ring-2 peer-checked:ring-blue-400">
                                    <i class="fas fa-tint text-xl" style="color: #4facfe;"></i>
                                    <span class="text-xs mt-1" style="color: #4facfe;">Wet Diaper</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="type" value="dirty" class="hidden peer">
                                <div class="quick-action dirty w-full h-20 peer-checked:ring-2 peer-checked:ring-orange-400">
                                    <i class="fas fa-poo text-xl" style="color: #f97316;"></i>
                                    <span class="text-xs mt-1" style="color: #f97316;">Dirty Diaper</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="type" value="medical" class="hidden peer">
                                <div class="quick-action medical w-full h-20 peer-checked:ring-2 peer-checked:ring-green-400">
                                    <i class="fas fa-notes-medical text-xl" style="color: #10b981;"></i>
                                    <span class="text-xs mt-1" style="color: #10b981;">Medical</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Date & Time -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Date</label>
                            <input type="date" id="record-date" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Time</label>
                            <input type="time" id="record-time" class="input-field" required>
                        </div>
                    </div>

                    <!-- Feeding Options -->
                    <div id="feeding-options" class="hidden">
                        <label class="block text-sm font-medium mb-2">Feeding Side</label>
                        <div class="flex gap-3">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="left" class="w-5 h-5 rounded" style="accent-color: var(--accent-pink);">
                                <span>Left</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" name="right" class="w-5 h-5 rounded" style="accent-color: var(--accent-pink);">
                                <span>Right</span>
                            </label>
                        </div>
                    </div>

                    <!-- Duration (for feeding/pumping) -->
                    <div id="duration-field" class="hidden">
                        <label class="block text-sm font-medium mb-2">Duration (minutes)</label>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" onclick="setDuration(5)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">5</button>
                            <button type="button" onclick="setDuration(10)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">10</button>
                            <button type="button" onclick="setDuration(15)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">15</button>
                            <button type="button" onclick="setDuration(20)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">20</button>
                            <button type="button" onclick="setDuration(25)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">25</button>
                            <button type="button" onclick="setDuration(30)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">30</button>
                            <button type="button" onclick="setDuration(45)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">45</button>
                            <button type="button" onclick="setDuration(60)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">60</button>
                        </div>
                        <input type="number" id="record-duration" class="input-field" placeholder="Or enter custom duration..." min="1" max="120">
                    </div>

                    <!-- Pumping Details -->
                    <div id="pumping-options" class="hidden grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Left Side (ml)</label>
                            <input type="number" id="pump-left" class="input-field" placeholder="e.g., 60" min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Right Side (ml)</label>
                            <input type="number" id="pump-right" class="input-field" placeholder="e.g., 60" min="0">
                        </div>
                    </div>

                    <!-- Medical Options -->
                    <div id="medical-options" class="hidden space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Medical Record Type</label>
                            <select id="medical-type" class="input-field">
                                <option value="checkup">Doctor Checkup</option>
                                <option value="vaccination">Vaccination</option>
                                <option value="medication">Medication</option>
                                <option value="temperature">Temperature</option>
                                <option value="weight">Weight Measurement</option>
                                <option value="milestone">Milestone</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div id="temp-field" class="hidden">
                                <label class="block text-sm font-medium mb-2">Temperature (Â°F)</label>
                                <input type="number" id="medical-temp" class="input-field" placeholder="e.g., 98.6" step="0.1" min="90" max="110">
                            </div>
                            <div id="weight-field" class="hidden">
                                <label class="block text-sm font-medium mb-2">Weight</label>
                                <div class="flex gap-2">
                                    <input type="number" id="medical-weight-lbs" class="input-field" placeholder="lbs" min="0" step="1">
                                    <input type="number" id="medical-weight-oz" class="input-field" placeholder="oz" min="0" max="15" step="0.5">
                                </div>
                            </div>
                        </div>
                        <div id="medication-field" class="hidden">
                            <label class="block text-sm font-medium mb-2">Medication Name</label>
                            <input type="text" id="medical-medication" class="input-field" placeholder="e.g., Tylenol">
                        </div>
                        <div id="vaccine-field" class="hidden">
                            <label class="block text-sm font-medium mb-2">Vaccine Name</label>
                            <input type="text" id="medical-vaccine" class="input-field" placeholder="e.g., DTaP, Hepatitis B">
                        </div>
                        <div id="milestone-field" class="hidden">
                            <label class="block text-sm font-medium mb-2">Milestone</label>
                            <input type="text" id="medical-milestone" class="input-field" placeholder="e.g., First smile, Rolled over">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Doctor/Provider (optional)</label>
                            <input type="text" id="medical-doctor" class="input-field" placeholder="e.g., Dr. Smith">
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Notes (optional)</label>
                        <textarea id="record-notes" class="input-field" rows="3" placeholder="Any additional notes..."></textarea>
                    </div>

                    <button type="submit" class="btn-primary w-full text-lg">
                        <i class="fas fa-save mr-2"></i>Save Record
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- History Tab -->
    <section id="tab-history" class="tab-content hidden">
        <div class="widget-card p-6">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <i class="fas fa-history" style="color: var(--accent-pink);"></i>
                    Session History
                </h3>
                <div class="flex flex-wrap gap-3">
                    <select id="filter-type" onchange="filterHistory()" class="input-field w-auto">
                        <option value="all">All Types</option>
                        <option value="feeding">Feeding</option>
                        <option value="pumping">Pumping</option>
                        <option value="wet">Wet Diaper</option>
                        <option value="dirty">Dirty Diaper</option>
                        <option value="medical">Medical</option>
                    </select>
                    <input type="date" id="filter-date" onchange="filterHistory()" class="input-field w-auto">
                    <button onclick="clearFilters()" class="btn-secondary">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div id="history-list" class="space-y-3 max-h-[600px] overflow-y-auto scrollbar-thin">
                <p class="text-center py-12" style="color: var(--text-secondary);">No records found</p>
            </div>
        </div>
    </section>

    <!-- Analytics Tab -->
    <section id="tab-analytics" class="tab-content hidden">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="widget-card p-6">
                <h3 class="font-semibold mb-4">Weekly Trend</h3>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="widget-card p-6">
                <h3 class="font-semibold mb-4">Hourly Distribution</h3>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>

        <div class="widget-card p-6">
            <h3 class="font-semibold mb-4">Statistics Summary</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="p-4 rounded-xl" style="background: var(--bg-secondary);">
                    <p class="text-sm" style="color: var(--text-secondary);">Total Records</p>
                    <p class="text-2xl font-bold" id="total-records">0</p>
                </div>
                <div class="p-4 rounded-xl" style="background: var(--bg-secondary);">
                    <p class="text-sm" style="color: var(--text-secondary);">Avg Daily Feedings</p>
                    <p class="text-2xl font-bold" id="avg-feedings">0</p>
                </div>
                <div class="p-4 rounded-xl" style="background: var(--bg-secondary);">
                    <p class="text-sm" style="color: var(--text-secondary);">Avg Daily Diapers</p>
                    <p class="text-2xl font-bold" id="avg-diapers">0</p>
                </div>
                <div class="p-4 rounded-xl" style="background: var(--bg-secondary);">
                    <p class="text-sm" style="color: var(--text-secondary);">Days Tracked</p>
                    <p class="text-2xl font-bold" id="days-tracked">0</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Delete Record</h3>
            <p class="mb-6" style="color: var(--text-secondary);">Are you sure you want to delete this record? This action cannot be undone.</p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeDeleteModal()" class="btn-secondary">Cancel</button>
                <button onclick="confirmDelete()" class="btn-primary" style="background: linear-gradient(135deg, #ef4444, #f87171);">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Record Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <i class="fas fa-edit" style="color: var(--accent-pink);"></i>
                    Edit Record
                </h3>
                <button onclick="closeEditModal()" class="p-2 rounded-lg hover:bg-gray-500/20 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="edit-form" onsubmit="saveEdit(event)">
                <div class="grid gap-5">
                    <!-- Record Info Display -->
                    <div class="p-4 rounded-xl" style="background: var(--bg-secondary);">
                        <div class="flex items-center gap-3">
                            <div id="edit-type-icon" class="w-12 h-12 rounded-xl flex items-center justify-center text-xl"></div>
                            <div>
                                <span id="edit-type-badge" class="badge"></span>
                                <p class="text-sm mt-1" style="color: var(--text-secondary);" id="edit-datetime"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Date & Time Edit -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Date</label>
                            <input type="date" id="edit-date" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Time</label>
                            <input type="time" id="edit-time" class="input-field" required>
                        </div>
                    </div>

                    <!-- Duration Field -->
                    <div id="edit-duration-container">
                        <label class="block text-sm font-medium mb-2">
                            <i class="fas fa-clock mr-1" style="color: var(--accent-pink);"></i>
                            Duration (minutes)
                        </label>
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" onclick="setEditDuration(5)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">5</button>
                            <button type="button" onclick="setEditDuration(10)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">10</button>
                            <button type="button" onclick="setEditDuration(15)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">15</button>
                            <button type="button" onclick="setEditDuration(20)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">20</button>
                            <button type="button" onclick="setEditDuration(25)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">25</button>
                            <button type="button" onclick="setEditDuration(30)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">30</button>
                            <button type="button" onclick="setEditDuration(45)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">45</button>
                            <button type="button" onclick="setEditDuration(60)" class="duration-preset px-3 py-2 rounded-lg text-sm font-medium transition-all hover:scale-105">60</button>
                        </div>
                        <input type="number" id="edit-duration" class="input-field" placeholder="Or enter custom duration..." min="1" max="120">
                        <p class="text-xs mt-2" style="color: var(--text-secondary);">
                            <i class="fas fa-info-circle mr-1"></i>
                            Add or update the session duration
                        </p>
                    </div>

                    <!-- Feeding Options -->
                    <div id="edit-feeding-options" class="hidden">
                        <label class="block text-sm font-medium mb-3">Feeding Side</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2 cursor-pointer p-3 rounded-xl transition-colors hover:bg-gray-500/10">
                                <input type="checkbox" id="edit-left" class="w-5 h-5 rounded" style="accent-color: var(--accent-pink);">
                                <span>Left Side</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-3 rounded-xl transition-colors hover:bg-gray-500/10">
                                <input type="checkbox" id="edit-right" class="w-5 h-5 rounded" style="accent-color: var(--accent-pink);">
                                <span>Right Side</span>
                            </label>
                        </div>
                    </div>

                    <!-- Pumping Options -->
                    <div id="edit-pumping-options" class="hidden grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Left Side (ml)</label>
                            <input type="number" id="edit-pump-left" class="input-field" placeholder="e.g., 60" min="0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Right Side (ml)</label>
                            <input type="number" id="edit-pump-right" class="input-field" placeholder="e.g., 60" min="0">
                        </div>
                    </div>

                    <!-- Notes -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Notes</label>
                        <textarea id="edit-notes" class="input-field" rows="2" placeholder="Any additional notes..."></textarea>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeEditModal()" class="btn-secondary flex-1">Cancel</button>
                        <button type="submit" class="btn-primary flex-1">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Feeding Side Selection Modal -->
    <div id="feeding-side-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 360px;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <i class="fas fa-baby-carriage" style="color: #ff6b9d;"></i>
                    Start Feeding
                </h3>
                <button onclick="closeFeedingSideModal()" class="p-2 rounded-lg hover:bg-gray-500/20 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <p class="text-sm mb-4" style="color: var(--text-secondary);">Which side are you feeding from?</p>

            <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="startFeeding('left')" class="feeding-side-btn p-4 rounded-xl flex flex-col items-center gap-2 transition-all hover:scale-105" style="background: linear-gradient(135deg, rgba(255, 107, 157, 0.2), rgba(255, 143, 171, 0.1)); border: 2px solid #ff6b9d;">
                    <i class="fas fa-arrow-left text-2xl" style="color: #ff6b9d;"></i>
                    <span class="text-sm font-medium" style="color: #ff6b9d;">Left</span>
                </button>
                <button onclick="startFeeding('right')" class="feeding-side-btn p-4 rounded-xl flex flex-col items-center gap-2 transition-all hover:scale-105" style="background: linear-gradient(135deg, rgba(255, 107, 157, 0.2), rgba(255, 143, 171, 0.1)); border: 2px solid #ff6b9d;">
                    <i class="fas fa-arrow-right text-2xl" style="color: #ff6b9d;"></i>
                    <span class="text-sm font-medium" style="color: #ff6b9d;">Right</span>
                </button>
                <button onclick="startFeeding('both')" class="feeding-side-btn p-4 rounded-xl flex flex-col items-center gap-2 transition-all hover:scale-105" style="background: linear-gradient(135deg, rgba(255, 107, 157, 0.2), rgba(255, 143, 171, 0.1)); border: 2px solid #ff6b9d;">
                    <i class="fas fa-arrows-alt-h text-2xl" style="color: #ff6b9d;"></i>
                    <span class="text-sm font-medium" style="color: #ff6b9d;">Both</span>
                </button>
            </div>

            <button onclick="startFeeding('none')" class="w-full py-3 rounded-xl text-sm transition-all hover:bg-gray-500/10" style="color: var(--text-secondary); border: 1px solid var(--border-color);">
                <i class="fas fa-question-circle mr-2"></i>Not sure / Decide later
            </button>
        </div>
    </div>

    <!-- Medical Quick Add Modal -->
    <div id="medical-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold flex items-center gap-2">
                    <i class="fas fa-notes-medical" style="color: #10b981;"></i>
                    Add Medical Record
                </h3>
                <button onclick="closeMedicalModal()" class="p-2 rounded-lg hover:bg-gray-500/20 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="medical-form" onsubmit="saveMedicalRecord(event)">
                <div class="grid gap-5">
                    <!-- Date & Time -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Date</label>
                            <input type="date" id="med-date" class="input-field" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Time</label>
                            <input type="time" id="med-time" class="input-field" required>
                        </div>
                    </div>

                    <!-- Medical Record Type -->
                    <div>
                        <label class="block text-sm font-medium mb-2">Record Type</label>
                        <select id="med-type" class="input-field" onchange="toggleMedicalFields()">
                            <option value="checkup">Doctor Checkup</option>
                            <option value="vaccination">Vaccination</option>
                            <option value="medication">Medication</option>
                            <option value="temperature">Temperature</option>
                            <option value="weight">Weight Measurement</option>
                            <option value="milestone">Milestone</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <!-- Dynamic Fields -->
                    <div id="med-temp-field" class="hidden">
                        <label class="block text-sm font-medium mb-2">Temperature (Â°F)</label>
                        <input type="number" id="med-temp" class="input-field" placeholder="e.g., 98.6" step="0.1" min="90" max="110">
                    </div>

                    <div id="med-weight-field" class="hidden">
                        <label class="block text-sm font-medium mb-2">Weight</label>
                        <div class="flex gap-2">
                            <input type="number" id="med-weight-lbs" class="input-field" placeholder="lbs" min="0" step="1">
                            <input type="number" id="med-weight-oz" class="input-field" placeholder="oz" min="0" max="15" step="0.5">
                        </div>
                    </div>

                    <div id="med-medication-field" class="hidden">
                        <label class="block text-sm font-medium mb-2">Medication Name</label>
                        <input type="text" id="med-medication" class="input-field" placeholder="e.g., Tylenol">
                        <div class="mt-2">
                            <label class="block text-sm font-medium mb-2">Dosage (optional)</label>
                            <input type="text" id="med-dosage" class="input-field" placeholder="e.g., 2.5ml">
                        </div>
                    </div>

                    <div id="med-vaccine-field" class="hidden">
                        <label class="block text-sm font-medium mb-2">Vaccine Name</label>
                        <input type="text" id="med-vaccine" class="input-field" placeholder="e.g., DTaP, Hepatitis B">
                    </div>

                    <div id="med-milestone-field" class="hidden">
                        <label class="block text-sm font-medium mb-2">Milestone</label>
                        <input type="text" id="med-milestone" class="input-field" placeholder="e.g., First smile, Rolled over">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Doctor/Provider (optional)</label>
                        <input type="text" id="med-doctor" class="input-field" placeholder="e.g., Dr. Smith">
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-2">Notes (optional)</label>
                        <textarea id="med-notes" class="input-field" rows="2" placeholder="Any additional notes..."></textarea>
                    </div>

                    <div class="flex gap-3 pt-2">
                        <button type="button" onclick="closeMedicalModal()" class="btn-secondary flex-1">Cancel</button>
                        <button type="submit" class="btn-primary flex-1" style="background: linear-gradient(135deg, #10b981, #34d399);">
                            <i class="fas fa-save mr-2"></i>Save Record
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 p-4 rounded-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-3" style="background: var(--accent-green);">
        <p class="text-white font-medium" id="toast-message">Record saved!</p>
        <button id="toast-action" class="hidden px-3 py-1 bg-white/20 hover:bg-white/30 rounded-lg text-white text-sm font-medium transition-colors"></button>
    </div>

    <script>
        // Initialize dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data storage
        let records = [];
        let deleteTargetId = null;
        let editTargetId = null;
        let activityChart, distributionChart, weeklyChart, hourlyChart;
        let hasUnsavedChanges = false;
        let lastSavedRecordsHash = '';
        let warningDismissed = false;

        function getRecordsHash() {
            return JSON.stringify(records);
        }

        function markAsUnsaved() {
            if (lastSavedRecordsHash && getRecordsHash() !== lastSavedRecordsHash) {
                hasUnsavedChanges = true;
                warningDismissed = false;
                showUnsavedWarning();
            }
        }

        function markAsSaved() {
            lastSavedRecordsHash = getRecordsHash();
            hasUnsavedChanges = false;
            hideUnsavedWarning();
        }

        function showUnsavedWarning() {
            if (hasUnsavedChanges && !warningDismissed) {
                const warning = document.getElementById('unsaved-warning');
                warning.classList.remove('hidden');
                document.getElementById('main-header').style.marginTop = '52px';
            }
        }

        function hideUnsavedWarning() {
            const warning = document.getElementById('unsaved-warning');
            warning.classList.add('hidden');
            document.getElementById('main-header').style.marginTop = '0';
        }

        function dismissUnsavedWarning() {
            warningDismissed = true;
            hideUnsavedWarning();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initDateTimeFields();
            initCharts();
            setupFormListeners();
            updateDashboard();
            updateLastUpdated();
            // Update last updated every minute
            setInterval(updateLastUpdated, 60000);
            // Update live timers every second
            setInterval(updateLiveTimers, 1000);
            // Refresh recent activity every minute to update "time ago"
            setInterval(() => {
                updateRecentActivity();
                filterHistory();
                updateLastFeedingDisplay();
            }, 60000);
        });

        function updateLiveTimers() {
            const liveTimers = document.querySelectorAll('.live-timer');
            const now = new Date();

            liveTimers.forEach(timer => {
                const startTime = new Date(timer.dataset.start);
                const diffMs = now - startTime;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffSecs = Math.floor((diffMs % (1000 * 60)) / 1000);
                const diffHours = Math.floor(diffMins / 60);

                let timeText;
                if (diffHours > 0) {
                    timeText = `${diffHours}h ${diffMins % 60}m ${diffSecs}s`;
                } else if (diffMins > 0) {
                    timeText = `${diffMins}m ${diffSecs}s`;
                } else {
                    timeText = `${diffSecs}s`;
                }

                timer.innerHTML = `<i class="fas fa-play-circle mr-1"></i>${timeText}`;
            });
        }

        function endSession(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            const now = new Date();
            const startTime = new Date(record.timestamp);
            const diffMs = now - startTime;
            const diffMins = Math.round(diffMs / (1000 * 60));

            // Set duration (minimum 1 minute)
            record.duration = Math.max(1, diffMins);

            updateDashboard();
            filterHistory();
            showToast(`Session ended: ${record.duration} min recorded!`);
        }

        function updateLastUpdated() {
            const dot = document.getElementById('last-updated-dot');
            const text = document.getElementById('last-updated-text');

            if (records.length === 0) {
                dot.className = 'w-2 h-2 rounded-full dot-gray';
                text.textContent = 'No records yet';
                text.className = 'text-sm';
                text.style.color = 'var(--text-secondary)';
                return;
            }

            // Find the most recent record by timestamp
            const sortedRecords = [...records].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const lastRecord = sortedRecords[0];
            const lastTime = new Date(lastRecord.timestamp);
            const now = new Date();
            const diffMs = now - lastTime;
            const diffHours = diffMs / (1000 * 60 * 60);
            const diffMins = Math.floor(diffMs / (1000 * 60));

            let timeText;
            if (diffMins < 1) {
                timeText = 'Just now';
            } else if (diffMins < 60) {
                timeText = `${diffMins} min ago`;
            } else if (diffHours < 24) {
                const hours = Math.floor(diffHours);
                timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                const days = Math.floor(diffHours / 24);
                timeText = `${days} day${days > 1 ? 's' : ''} ago`;
            }

            text.textContent = `Last updated: ${timeText}`;

            // Color coding: red if more than 3 hours, green otherwise
            if (diffHours > 3) {
                dot.className = 'w-2 h-2 rounded-full dot-red';
                text.className = 'text-sm status-red';
            } else {
                dot.className = 'w-2 h-2 rounded-full dot-green';
                text.className = 'text-sm status-green';
            }
        }

        function setDuration(minutes) {
            document.getElementById('record-duration').value = minutes;
            // Update active state
            document.querySelectorAll('#duration-field .duration-preset').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === minutes) {
                    btn.classList.add('active');
                }
            });
        }

        function setEditDuration(minutes) {
            document.getElementById('edit-duration').value = minutes;
            // Update active state
            document.querySelectorAll('#edit-duration-container .duration-preset').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === minutes) {
                    btn.classList.add('active');
                }
            });
        }

        function initDateTimeFields() {
            const now = new Date();
            document.getElementById('record-date').value = now.toISOString().split('T')[0];
            document.getElementById('record-time').value = now.toTimeString().slice(0, 5);
        }

        function setupFormListeners() {
            const typeInputs = document.querySelectorAll('input[name="type"]');
            typeInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    const type = e.target.value;
                    document.getElementById('feeding-options').classList.toggle('hidden', type !== 'feeding');
                    document.getElementById('duration-field').classList.toggle('hidden', !['feeding', 'pumping'].includes(type));
                    document.getElementById('pumping-options').classList.toggle('hidden', type !== 'pumping');
                    document.getElementById('medical-options').classList.toggle('hidden', type !== 'medical');

                    if (type === 'medical') {
                        setupMedicalTypeListener();
                    }
                });
            });
        }

        function setupMedicalTypeListener() {
            const medTypeSelect = document.getElementById('medical-type');
            if (medTypeSelect) {
                medTypeSelect.addEventListener('change', toggleAddFormMedicalFields);
                toggleAddFormMedicalFields();
            }
        }

        function toggleAddFormMedicalFields() {
            const medType = document.getElementById('medical-type').value;
            document.getElementById('temp-field').classList.toggle('hidden', medType !== 'temperature');
            document.getElementById('weight-field').classList.toggle('hidden', medType !== 'weight');
            document.getElementById('medication-field').classList.toggle('hidden', medType !== 'medication');
            document.getElementById('vaccine-field').classList.toggle('hidden', medType !== 'vaccination');
            document.getElementById('milestone-field').classList.toggle('hidden', medType !== 'milestone');
        }

        function toggleMedicalFields() {
            const medType = document.getElementById('med-type').value;
            document.getElementById('med-temp-field').classList.toggle('hidden', medType !== 'temperature');
            document.getElementById('med-weight-field').classList.toggle('hidden', medType !== 'weight');
            document.getElementById('med-medication-field').classList.toggle('hidden', medType !== 'medication');
            document.getElementById('med-vaccine-field').classList.toggle('hidden', medType !== 'vaccination');
            document.getElementById('med-milestone-field').classList.toggle('hidden', medType !== 'milestone');
        }

        function openMedicalModal() {
            const now = new Date();
            document.getElementById('med-date').value = now.toISOString().split('T')[0];
            document.getElementById('med-time').value = now.toTimeString().slice(0, 5);
            document.getElementById('med-type').value = 'checkup';
            toggleMedicalFields();
            document.getElementById('medical-modal').classList.add('active');
        }

        function closeMedicalModal() {
            document.getElementById('medical-modal').classList.remove('active');
            document.getElementById('medical-form').reset();
            editMedicalId = null;
            // Reset modal title
            const modalTitle = document.querySelector('#medical-modal h3');
            modalTitle.innerHTML = '<i class="fas fa-notes-medical" style="color: #10b981;"></i> Add Medical Record';
        }

        function saveMedicalRecord(event) {
            event.preventDefault();

            const medType = document.getElementById('med-type').value;
            const record = {
                id: Date.now(),
                type: 'medical',
                medicalType: medType,
                date: document.getElementById('med-date').value,
                time: document.getElementById('med-time').value,
                timestamp: new Date(`${document.getElementById('med-date').value}T${document.getElementById('med-time').value}`).toISOString(),
                doctor: document.getElementById('med-doctor').value,
                notes: document.getElementById('med-notes').value
            };

            // Add type-specific data
            if (medType === 'temperature') {
                record.temperature = parseFloat(document.getElementById('med-temp').value) || null;
            } else if (medType === 'weight') {
                record.weightLbs = parseInt(document.getElementById('med-weight-lbs').value) || 0;
                record.weightOz = parseFloat(document.getElementById('med-weight-oz').value) || 0;
            } else if (medType === 'medication') {
                record.medication = document.getElementById('med-medication').value;
                record.dosage = document.getElementById('med-dosage').value;
            } else if (medType === 'vaccination') {
                record.vaccine = document.getElementById('med-vaccine').value;
            } else if (medType === 'milestone') {
                record.milestone = document.getElementById('med-milestone').value;
            }

            records.unshift(record);
            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            closeMedicalModal();
            updateDashboard();
            showToast('Medical record saved!');
        }

        let editMedicalId = null;

        function openEditMedicalModal(record) {
            editMedicalId = record.id;

            document.getElementById('med-date').value = record.date;
            document.getElementById('med-time').value = record.time;
            document.getElementById('med-type').value = record.medicalType || 'checkup';
            document.getElementById('med-doctor').value = record.doctor || '';
            document.getElementById('med-notes').value = record.notes || '';

            toggleMedicalFields();

            // Populate type-specific fields
            if (record.medicalType === 'temperature' && record.temperature) {
                document.getElementById('med-temp').value = record.temperature;
            }
            if (record.medicalType === 'weight') {
                document.getElementById('med-weight-lbs').value = record.weightLbs || '';
                document.getElementById('med-weight-oz').value = record.weightOz || '';
            }
            if (record.medicalType === 'medication') {
                document.getElementById('med-medication').value = record.medication || '';
                document.getElementById('med-dosage').value = record.dosage || '';
            }
            if (record.medicalType === 'vaccination') {
                document.getElementById('med-vaccine').value = record.vaccine || '';
            }
            if (record.medicalType === 'milestone') {
                document.getElementById('med-milestone').value = record.milestone || '';
            }

            // Change the modal title and button to indicate editing
            const modalTitle = document.querySelector('#medical-modal h3');
            modalTitle.innerHTML = '<i class="fas fa-edit" style="color: #10b981;"></i> Edit Medical Record';

            document.getElementById('medical-modal').classList.add('active');
        }

        // Override saveMedicalRecord to handle edits
        const originalSaveMedical = saveMedicalRecord;
        saveMedicalRecord = function(event) {
            event.preventDefault();

            const medType = document.getElementById('med-type').value;
            const recordData = {
                type: 'medical',
                medicalType: medType,
                date: document.getElementById('med-date').value,
                time: document.getElementById('med-time').value,
                timestamp: new Date(`${document.getElementById('med-date').value}T${document.getElementById('med-time').value}`).toISOString(),
                doctor: document.getElementById('med-doctor').value,
                notes: document.getElementById('med-notes').value
            };

            // Add type-specific data
            if (medType === 'temperature') {
                recordData.temperature = parseFloat(document.getElementById('med-temp').value) || null;
            } else if (medType === 'weight') {
                recordData.weightLbs = parseInt(document.getElementById('med-weight-lbs').value) || 0;
                recordData.weightOz = parseFloat(document.getElementById('med-weight-oz').value) || 0;
            } else if (medType === 'medication') {
                recordData.medication = document.getElementById('med-medication').value;
                recordData.dosage = document.getElementById('med-dosage').value;
            } else if (medType === 'vaccination') {
                recordData.vaccine = document.getElementById('med-vaccine').value;
            } else if (medType === 'milestone') {
                recordData.milestone = document.getElementById('med-milestone').value;
            }

            if (editMedicalId) {
                // Update existing record
                const record = records.find(r => r.id === editMedicalId);
                if (record) {
                    Object.assign(record, recordData);
                }
                editMedicalId = null;
                showToast('Medical record updated!');
            } else {
                // Create new record
                recordData.id = Date.now();
                records.unshift(recordData);
                showToast('Medical record saved!');
            }

            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            closeMedicalModal();
            updateDashboard();
            filterHistory();

            // Reset modal title
            const modalTitle = document.querySelector('#medical-modal h3');
            modalTitle.innerHTML = '<i class="fas fa-notes-medical" style="color: #10b981;"></i> Add Medical Record';
        };

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));

            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            if (tabName === 'history') filterHistory();
            if (tabName === 'analytics') updateAnalytics();
        }

        function quickAdd(type) {
            // For feeding, show side selection modal first
            if (type === 'feeding') {
                openFeedingSideModal();
                return;
            }

            const now = new Date();
            const record = {
                id: Date.now(),
                type: type,
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().slice(0, 5),
                timestamp: now.toISOString(),
                duration: null,
                notes: ''
            };
            records.unshift(record);
            updateDashboard();

            // For pumping, show toast with edit option
            if (type === 'pumping') {
                showToastWithAction(
                    `${type.charAt(0).toUpperCase() + type.slice(1)} started!`,
                    'Add Details',
                    () => openEditModal(record.id)
                );
            } else {
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} recorded!`);
            }
        }

        function openFeedingSideModal() {
            document.getElementById('feeding-side-modal').classList.add('active');
        }

        function closeFeedingSideModal() {
            document.getElementById('feeding-side-modal').classList.remove('active');
        }

        function startFeeding(side) {
            closeFeedingSideModal();

            const now = new Date();
            const record = {
                id: Date.now(),
                type: 'feeding',
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().slice(0, 5),
                timestamp: now.toISOString(),
                duration: null,
                leftSide: side === 'left' || side === 'both',
                rightSide: side === 'right' || side === 'both',
                notes: ''
            };
            records.unshift(record);
            updateDashboard();

            const sideText = side === 'both' ? 'Both sides' : side === 'none' ? 'Feeding' : `${side.charAt(0).toUpperCase() + side.slice(1)} side`;
            showToastWithAction(
                `${sideText} started!`,
                'Add Duration',
                () => openEditModal(record.id)
            );
        }

        function addRecord(event) {
            event.preventDefault();
            const form = event.target;
            const type = form.querySelector('input[name="type"]:checked')?.value;

            if (!type) {
                showToast('Please select a record type', 'error');
                return;
            }

            const record = {
                id: Date.now(),
                type: type,
                date: document.getElementById('record-date').value,
                time: document.getElementById('record-time').value,
                timestamp: new Date(`${document.getElementById('record-date').value}T${document.getElementById('record-time').value}`).toISOString(),
                duration: document.getElementById('record-duration').value ? parseInt(document.getElementById('record-duration').value) : null,
                notes: document.getElementById('record-notes').value
            };

            if (type === 'feeding') {
                record.leftSide = form.querySelector('input[name="left"]').checked;
                record.rightSide = form.querySelector('input[name="right"]').checked;
            }

            if (type === 'pumping') {
                record.pumpLeft = document.getElementById('pump-left').value ? parseInt(document.getElementById('pump-left').value) : null;
                record.pumpRight = document.getElementById('pump-right').value ? parseInt(document.getElementById('pump-right').value) : null;
            }

            records.unshift(record);
            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            form.reset();
            initDateTimeFields();
            document.getElementById('feeding-options').classList.add('hidden');
            document.getElementById('duration-field').classList.add('hidden');
            document.getElementById('pumping-options').classList.add('hidden');

            updateDashboard();
            showToast('Record saved successfully!');
            switchTab('dashboard');
        }

        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = records.filter(r => r.date === today);

            const stats = {
                feeding: todayRecords.filter(r => r.type === 'feeding'),
                pumping: todayRecords.filter(r => r.type === 'pumping'),
                wet: todayRecords.filter(r => r.type === 'wet'),
                dirty: todayRecords.filter(r => r.type === 'dirty'),
                medical: records.filter(r => r.type === 'medical')
            };

            document.getElementById('stat-feeding').textContent = stats.feeding.length;
            document.getElementById('stat-pumping').textContent = stats.pumping.length;
            document.getElementById('stat-wet').textContent = stats.wet.length;
            document.getElementById('stat-dirty').textContent = stats.dirty.length;
            document.getElementById('stat-medical').textContent = stats.medical.length;

            const feedingDuration = stats.feeding.reduce((sum, r) => sum + (r.duration || 0), 0);
            const pumpingDuration = stats.pumping.reduce((sum, r) => sum + (r.duration || 0), 0);
            document.getElementById('feeding-duration').textContent = feedingDuration;
            document.getElementById('pumping-duration').textContent = pumpingDuration;

            // Update last medical record info
            if (stats.medical.length > 0) {
                const lastMed = stats.medical[0];
                const medLabels = { checkup: 'Checkup', vaccination: 'Vaccine', medication: 'Medication', temperature: 'Temp', weight: 'Weight', milestone: 'Milestone', other: 'Other' };
                document.getElementById('last-medical').textContent = `Last: ${medLabels[lastMed.medicalType] || 'Record'}`;
            } else {
                document.getElementById('last-medical').textContent = 'No records';
            }

            // Update last feeding info
            updateLastFeedingDisplay();

            updateRecentActivity();
            updateCharts();
            updateLastUpdated();
            markAsUnsaved();
        }

        function updateLastFeedingDisplay() {
            const allFeedings = records.filter(r => r.type === 'feeding').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const lastFeedingTimeEl = document.getElementById('last-feeding-time');
            const lastFeedingDetailsEl = document.getElementById('last-feeding-details');
            const lastFeedingAlert = document.getElementById('last-feeding-alert');

            if (allFeedings.length === 0) {
                lastFeedingTimeEl.textContent = 'No feedings yet';
                lastFeedingTimeEl.style.color = 'var(--text-secondary)';
                lastFeedingDetailsEl.innerHTML = '';
                return;
            }

            const lastFeeding = allFeedings[0];
            const feedingTime = new Date(lastFeeding.timestamp);
            const now = new Date();
            const diffMs = now - feedingTime;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMins / 60);
            const remainingMins = diffMins % 60;

            let timeText;
            let timeColor;

            if (diffMins < 1) {
                timeText = 'Just now';
                timeColor = '#10b981'; // green
            } else if (diffMins < 60) {
                timeText = `${diffMins} minutes ago`;
                timeColor = diffMins > 30 ? '#fbbf24' : '#10b981'; // yellow if > 30 min
            } else if (diffHours < 3) {
                timeText = `${diffHours}h ${remainingMins}m ago`;
                timeColor = '#fbbf24'; // yellow
            } else {
                timeText = `${diffHours}h ${remainingMins}m ago`;
                timeColor = '#ef4444'; // red - it's been too long!
            }

            lastFeedingTimeEl.textContent = timeText;
            lastFeedingTimeEl.style.color = timeColor;

            // Build details
            let detailsHtml = '';

            // Side info
            const sides = [];
            if (lastFeeding.leftSide) sides.push('Left');
            if (lastFeeding.rightSide) sides.push('Right');
            if (sides.length > 0) {
                detailsHtml += `<span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(255, 107, 157, 0.2); color: #ff6b9d;"><i class="fas fa-arrows-alt-h mr-1"></i>${sides.join(' & ')}</span>`;
            }

            // Duration
            if (lastFeeding.duration) {
                detailsHtml += `<span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(255, 107, 157, 0.2); color: #ff6b9d;"><i class="fas fa-clock mr-1"></i>${lastFeeding.duration} min</span>`;
            } else {
                detailsHtml += `<span class="px-2 py-1 rounded-full text-xs font-medium" style="background: rgba(16, 185, 129, 0.2); color: #10b981;"><i class="fas fa-play-circle mr-1"></i>In progress</span>`;
            }

            // Time started
            const startTime = feedingTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            detailsHtml += `<span class="px-2 py-1 rounded-full text-xs font-medium" style="background: var(--bg-secondary); color: var(--text-secondary);"><i class="fas fa-clock mr-1"></i>${startTime}</span>`;

            lastFeedingDetailsEl.innerHTML = detailsHtml;

            // Add warning styling if it's been too long
            if (diffHours >= 3) {
                lastFeedingAlert.style.borderColor = '#ef4444';
                lastFeedingAlert.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.2)';
            } else {
                lastFeedingAlert.style.borderColor = '';
                lastFeedingAlert.style.boxShadow = '';
            }
        }

        function updateRecentActivity() {
            const container = document.getElementById('recent-activity');
            const recent = records.slice(0, 5);

            if (recent.length === 0) {
                container.innerHTML = '<p class="text-center py-8" style="color: var(--text-secondary);">No records yet. Start tracking!</p>';
                return;
            }

            container.innerHTML = recent.map(record => createRecordCard(record, true)).join('');
        }

        function createRecordCard(record, compact = false) {
            const icons = {
                feeding: '<i class="fas fa-baby-carriage"></i>',
                pumping: '<i class="fas fa-prescription-bottle"></i>',
                wet: '<i class="fas fa-tint"></i>',
                dirty: '<i class="fas fa-poo"></i>',
                medical: '<i class="fas fa-notes-medical"></i>'
            };

            const colors = {
                feeding: '#ff6b9d',
                pumping: '#a855f7',
                wet: '#4facfe',
                dirty: '#f97316',
                medical: '#10b981'
            };

            const medicalTypeLabels = {
                checkup: 'Checkup',
                vaccination: 'Vaccination',
                medication: 'Medication',
                temperature: 'Temperature',
                weight: 'Weight',
                milestone: 'Milestone',
                other: 'Other'
            };

            const dateObj = new Date(record.timestamp);
            const timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

            // Calculate time ago
            const now = new Date();
            const diffMs = now - dateObj;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            let timeAgo;
            if (diffMins < 1) {
                timeAgo = 'Just now';
            } else if (diffMins < 60) {
                timeAgo = `${diffMins} min ago`;
            } else if (diffHours < 24) {
                timeAgo = `${diffHours}h ${diffMins % 60}m ago`;
            } else if (diffDays === 1) {
                timeAgo = 'Yesterday';
            } else {
                timeAgo = `${diffDays} days ago`;
            }

            let details = '';
            let detailsHtml = '';
            let liveTimer = '';

            // Feeding details
            if (record.type === 'feeding') {
                const sides = [];
                if (record.leftSide) sides.push('<span style="color: #ff6b9d;"><i class="fas fa-arrow-left mr-1"></i>Left</span>');
                if (record.rightSide) sides.push('<span style="color: #ff6b9d;"><i class="fas fa-arrow-right mr-1"></i>Right</span>');

                if (record.duration) {
                    detailsHtml = `<span class="text-sm font-medium" style="color: #ff6b9d;"><i class="fas fa-clock mr-1"></i>${record.duration} min</span>`;
                } else {
                    // Show live timer for ongoing feeding with stop button
                    liveTimer = `
                        <span class="text-sm font-medium live-timer" data-start="${record.timestamp}" style="color: #10b981;"><i class="fas fa-play-circle mr-1"></i>In progress...</span>
                        <button onclick="endSession(${record.id})" class="stop-session-btn ml-2 px-3 py-1 rounded-full text-xs font-semibold transition-all hover:scale-105" title="End session and record duration">
                            <i class="fas fa-stop-circle mr-1"></i>Stop
                        </button>
                    `;
                }

                if (sides.length > 0) {
                    detailsHtml += (detailsHtml ? ' <span style="color: var(--text-secondary);">â¢</span> ' : '') + sides.join(' <span style="color: var(--text-secondary);">&</span> ');
                }
            }
            // Pumping details
            else if (record.type === 'pumping') {
                if (record.duration) {
                    detailsHtml = `<span class="text-sm font-medium" style="color: #a855f7;"><i class="fas fa-clock mr-1"></i>${record.duration} min</span>`;
                } else {
                    liveTimer = `
                        <span class="text-sm font-medium live-timer" data-start="${record.timestamp}" style="color: #10b981;"><i class="fas fa-play-circle mr-1"></i>In progress...</span>
                        <button onclick="endSession(${record.id})" class="stop-session-btn ml-2 px-3 py-1 rounded-full text-xs font-semibold transition-all hover:scale-105" title="End session and record duration">
                            <i class="fas fa-stop-circle mr-1"></i>Stop
                        </button>
                    `;
                }
                if (record.pumpLeft || record.pumpRight) {
                    detailsHtml += (detailsHtml ? ' <span style="color: var(--text-secondary);">â¢</span> ' : '');
                    detailsHtml += `<span class="text-sm" style="color: #a855f7;"><i class="fas fa-arrow-left mr-1"></i>${record.pumpLeft || 0}ml</span>`;
                    detailsHtml += ` <span class="text-sm" style="color: #a855f7;"><i class="fas fa-arrow-right mr-1"></i>${record.pumpRight || 0}ml</span>`;
                }
            }
            // Medical record details
            else if (record.type === 'medical') {
                detailsHtml = `<span class="text-sm font-medium" style="color: #10b981;">${medicalTypeLabels[record.medicalType] || 'Medical'}</span>`;
                if (record.temperature) detailsHtml += ` <span style="color: var(--text-secondary);">â¢</span> <span class="text-sm" style="color: #10b981;"><i class="fas fa-thermometer-half mr-1"></i>${record.temperature}Â°F</span>`;
                if (record.weightLbs || record.weightOz) detailsHtml += ` <span style="color: var(--text-secondary);">â¢</span> <span class="text-sm" style="color: #10b981;"><i class="fas fa-weight mr-1"></i>${record.weightLbs || 0}lbs ${record.weightOz || 0}oz</span>`;
                if (record.medication) detailsHtml += ` <span style="color: var(--text-secondary);">â¢</span> <span class="text-sm" style="color: #10b981;"><i class="fas fa-pills mr-1"></i>${record.medication}${record.dosage ? ' (' + record.dosage + ')' : ''}</span>`;
                if (record.vaccine) detailsHtml += ` <span style="color: var(--text-secondary);">â¢</span> <span class="text-sm" style="color: #10b981;"><i class="fas fa-syringe mr-1"></i>${record.vaccine}</span>`;
                if (record.milestone) detailsHtml += ` <span style="color: var(--text-secondary);">â¢</span> <span class="text-sm" style="color: #10b981;"><i class="fas fa-star mr-1"></i>${record.milestone}</span>`;
                if (record.doctor) detailsHtml += ` <span style="color: var(--text-secondary);">â¢</span> <span class="text-sm"><i class="fas fa-user-md mr-1"></i>${record.doctor}</span>`;
            }

            // Type-specific summary for quick view
            let typeSummary = '';
            if (record.type === 'feeding') {
                const sideInfo = [];
                if (record.leftSide) sideInfo.push('L');
                if (record.rightSide) sideInfo.push('R');
                typeSummary = sideInfo.length > 0 ? `(${sideInfo.join('+')})` : '';
            } else if (record.type === 'pumping' && (record.pumpLeft || record.pumpRight)) {
                const total = (record.pumpLeft || 0) + (record.pumpRight || 0);
                typeSummary = `(${total}ml)`;
            } else if (record.type === 'medical') {
                typeSummary = `(${medicalTypeLabels[record.medicalType] || 'Record'})`;
            }

            return `
                <div class="history-row p-4 flex items-center gap-4" data-id="${record.id}">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl flex-shrink-0" style="background: ${colors[record.type]}20; color: ${colors[record.type]};">
                        ${icons[record.type]}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="badge badge-${record.type}">${record.type} ${typeSummary}</span>
                            <span class="text-xs font-medium px-2 py-1 rounded-full time-ago-badge" style="background: var(--bg-secondary); color: var(--text-primary);">
                                <i class="fas fa-clock mr-1" style="color: ${colors[record.type]};"></i>${timeAgo}
                            </span>
                            ${liveTimer}
                        </div>
                        ${detailsHtml ? `<div class="flex flex-wrap items-center gap-1 mt-2">${detailsHtml}</div>` : ''}
                        <div class="flex flex-wrap items-center gap-3 mt-2 text-xs" style="color: var(--text-secondary);">
                            <span><i class="fas fa-calendar-alt mr-1"></i>${dateStr}</span>
                            ${(record.type === 'feeding' || record.type === 'pumping') ? `
                                <span class="font-medium" style="color: #10b981;"><i class="fas fa-play mr-1"></i>Started: ${timeStr}</span>
                                ${record.duration ? `
                                    <span class="font-medium" style="color: #ef4444;"><i class="fas fa-stop mr-1"></i>Ended: ${new Date(dateObj.getTime() + record.duration * 60000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>
                                    <span class="font-medium" style="color: ${colors[record.type]};"><i class="fas fa-hourglass-end mr-1"></i>${record.duration} min</span>
                                ` : `
                                    <span class="font-medium" style="color: #fbbf24;"><i class="fas fa-spinner fa-pulse mr-1"></i>In progress</span>
                                `}
                            ` : `
                                <span><i class="fas fa-clock mr-1"></i>${timeStr}</span>
                            `}
                        </div>
                        ${record.notes ? `<p class="text-xs mt-2 p-2 rounded-lg truncate" style="background: var(--bg-secondary); color: var(--text-secondary);"><i class="fas fa-sticky-note mr-1"></i>${record.notes}</p>` : ''}
                    </div>
                    <div class="flex flex-col items-center gap-1 flex-shrink-0">
                        <button onclick="openEditModal(${record.id})" class="delete-btn p-2 rounded-lg hover:bg-blue-500/20 text-blue-400 transition-colors" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="openDeleteModal(${record.id})" class="delete-btn p-2 rounded-lg hover:bg-red-500/20 text-red-400 transition-colors" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function filterHistory() {
            const typeFilter = document.getElementById('filter-type').value;
            const dateFilter = document.getElementById('filter-date').value;

            let filtered = records;
            if (typeFilter !== 'all') {
                filtered = filtered.filter(r => r.type === typeFilter);
            }
            if (dateFilter) {
                filtered = filtered.filter(r => r.date === dateFilter);
            }

            const container = document.getElementById('history-list');
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center py-12" style="color: var(--text-secondary);">No records found</p>';
                return;
            }

            container.innerHTML = filtered.map(record => createRecordCard(record)).join('');
        }

        function clearFilters() {
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-date').value = '';
            filterHistory();
        }

        function openDeleteModal(id) {
            deleteTargetId = id;
            document.getElementById('delete-modal').classList.add('active');
        }

        function closeDeleteModal() {
            deleteTargetId = null;
            document.getElementById('delete-modal').classList.remove('active');
        }

        function confirmDelete() {
            if (deleteTargetId) {
                records = records.filter(r => r.id !== deleteTargetId);
                updateDashboard();
                filterHistory();
                showToast('Record deleted');
            }
            closeDeleteModal();
        }

        function openEditModal(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            // For medical records, open the medical modal instead
            if (record.type === 'medical') {
                openEditMedicalModal(record);
                return;
            }

            editTargetId = id;

            const icons = {
                feeding: '<i class="fas fa-baby-carriage"></i>',
                pumping: '<i class="fas fa-prescription-bottle"></i>',
                wet: '<i class="fas fa-tint"></i>',
                dirty: '<i class="fas fa-poo"></i>'
            };

            const colors = {
                feeding: '#ff6b9d',
                pumping: '#a855f7',
                wet: '#4facfe',
                dirty: '#f97316'
            };

            // Set type display
            const iconEl = document.getElementById('edit-type-icon');
            iconEl.innerHTML = icons[record.type];
            iconEl.style.background = `${colors[record.type]}20`;
            iconEl.style.color = colors[record.type];

            const badgeEl = document.getElementById('edit-type-badge');
            badgeEl.textContent = record.type;
            badgeEl.className = `badge badge-${record.type}`;

            const dateObj = new Date(record.timestamp);
            document.getElementById('edit-datetime').textContent =
                dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Set form values
            document.getElementById('edit-date').value = record.date;
            document.getElementById('edit-time').value = record.time;
            document.getElementById('edit-duration').value = record.duration || '';
            document.getElementById('edit-notes').value = record.notes || '';

            // Show/hide duration field based on type
            const durationContainer = document.getElementById('edit-duration-container');
            durationContainer.classList.toggle('hidden', !['feeding', 'pumping'].includes(record.type));

            // Feeding options
            const feedingOptions = document.getElementById('edit-feeding-options');
            feedingOptions.classList.toggle('hidden', record.type !== 'feeding');
            if (record.type === 'feeding') {
                document.getElementById('edit-left').checked = record.leftSide || false;
                document.getElementById('edit-right').checked = record.rightSide || false;
            }

            // Pumping options
            const pumpingOptions = document.getElementById('edit-pumping-options');
            pumpingOptions.classList.toggle('hidden', record.type !== 'pumping');
            if (record.type === 'pumping') {
                document.getElementById('edit-pump-left').value = record.pumpLeft || '';
                document.getElementById('edit-pump-right').value = record.pumpRight || '';
            }

            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            editTargetId = null;
            document.getElementById('edit-modal').classList.remove('active');
        }

        function saveEdit(event) {
            event.preventDefault();

            const record = records.find(r => r.id === editTargetId);
            if (!record) return;

            // Update date/time
            record.date = document.getElementById('edit-date').value;
            record.time = document.getElementById('edit-time').value;
            record.timestamp = new Date(`${record.date}T${record.time}`).toISOString();

            // Update duration
            const durationVal = document.getElementById('edit-duration').value;
            record.duration = durationVal ? parseInt(durationVal) : null;

            // Update notes
            record.notes = document.getElementById('edit-notes').value;

            // Update feeding options
            if (record.type === 'feeding') {
                record.leftSide = document.getElementById('edit-left').checked;
                record.rightSide = document.getElementById('edit-right').checked;
            }

            // Update pumping options
            if (record.type === 'pumping') {
                const pumpLeftVal = document.getElementById('edit-pump-left').value;
                const pumpRightVal = document.getElementById('edit-pump-right').value;
                record.pumpLeft = pumpLeftVal ? parseInt(pumpLeftVal) : null;
                record.pumpRight = pumpRightVal ? parseInt(pumpRightVal) : null;
            }

            // Re-sort records by timestamp
            records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            closeEditModal();
            updateDashboard();
            filterHistory();
            showToast('Record updated successfully!');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            const toastAction = document.getElementById('toast-action');

            toastMsg.textContent = message;
            toastAction.classList.add('hidden');
            toast.style.background = type === 'error' ? '#ef4444' : 'var(--accent-green)';
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        }

        function showToastWithAction(message, actionText, actionCallback) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-message');
            const toastAction = document.getElementById('toast-action');

            toastMsg.textContent = message;
            toastAction.textContent = actionText;
            toastAction.classList.remove('hidden');
            toastAction.onclick = () => {
                hideToast();
                actionCallback();
            };

            toast.style.background = 'var(--accent-green)';
            toast.classList.remove('translate-y-20', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');

            setTimeout(() => {
                hideToast();
            }, 5000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            const toastAction = document.getElementById('toast-action');
            toast.classList.add('translate-y-20', 'opacity-0');
            toast.classList.remove('translate-y-0', 'opacity-100');
            toastAction.classList.add('hidden');
        }

        function initCharts() {
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            // Activity Chart
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Feedings',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#ff6b9d',
                        backgroundColor: 'rgba(255, 107, 157, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Diapers',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Distribution Chart
            const distCtx = document.getElementById('distributionChart').getContext('2d');
            distributionChart = new Chart(distCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Feeding', 'Pumping', 'Wet', 'Dirty'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#ff6b9d', '#a855f7', '#4facfe', '#f97316'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        function updateCharts() {
            const last7Days = [];
            const feedingData = [];
            const diaperData = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                const dayRecords = records.filter(r => r.date === dateStr);
                feedingData.push(dayRecords.filter(r => r.type === 'feeding').length);
                diaperData.push(dayRecords.filter(r => r.type === 'wet' || r.type === 'dirty').length);
            }

            activityChart.data.labels = last7Days;
            activityChart.data.datasets[0].data = feedingData;
            activityChart.data.datasets[1].data = diaperData;
            activityChart.update();

            // Distribution
            const distData = [
                records.filter(r => r.type === 'feeding').length,
                records.filter(r => r.type === 'pumping').length,
                records.filter(r => r.type === 'wet').length,
                records.filter(r => r.type === 'dirty').length
            ];
            distributionChart.data.datasets[0].data = distData;
            distributionChart.update();
        }

        function updateAnalytics() {
            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            const textColor = isDark ? '#94a3b8' : '#64748b';

            // Weekly Chart
            if (!weeklyChart) {
                const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
                weeklyChart = new Chart(weeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{
                            label: 'Feeding',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#ff6b9d'
                        }, {
                            label: 'Pumping',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#a855f7'
                        }, {
                            label: 'Wet',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#4facfe'
                        }, {
                            label: 'Dirty',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#f97316'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: gridColor } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }

            // Hourly Chart
            if (!hourlyChart) {
                const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
                hourlyChart = new Chart(hourlyCtx, {
                    type: 'radar',
                    data: {
                        labels: ['12am', '3am', '6am', '9am', '12pm', '3pm', '6pm', '9pm'],
                        datasets: [{
                            label: 'Activity',
                            data: [0, 0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#ff6b9d',
                            backgroundColor: 'rgba(255, 107, 157, 0.2)',
                            pointBackgroundColor: '#ff6b9d'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            r: {
                                beginAtZero: true,
                                grid: { color: gridColor },
                                pointLabels: { color: textColor }
                            }
                        }
                    }
                });
            }

            // Update weekly data
            const weekData = { feeding: [0,0,0,0,0,0,0], pumping: [0,0,0,0,0,0,0], wet: [0,0,0,0,0,0,0], dirty: [0,0,0,0,0,0,0] };
            const labels = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                const dayRecords = records.filter(r => r.date === dateStr);
                weekData.feeding[6-i] = dayRecords.filter(r => r.type === 'feeding').length;
                weekData.pumping[6-i] = dayRecords.filter(r => r.type === 'pumping').length;
                weekData.wet[6-i] = dayRecords.filter(r => r.type === 'wet').length;
                weekData.dirty[6-i] = dayRecords.filter(r => r.type === 'dirty').length;
            }

            weeklyChart.data.labels = labels;
            weeklyChart.data.datasets[0].data = weekData.feeding;
            weeklyChart.data.datasets[1].data = weekData.pumping;
            weeklyChart.data.datasets[2].data = weekData.wet;
            weeklyChart.data.datasets[3].data = weekData.dirty;
            weeklyChart.update();

            // Update hourly data
            const hourlyData = [0, 0, 0, 0, 0, 0, 0, 0];
            records.forEach(r => {
                const hour = parseInt(r.time.split(':')[0]);
                const bucket = Math.floor(hour / 3);
                hourlyData[bucket]++;
            });
            hourlyChart.data.datasets[0].data = hourlyData;
            hourlyChart.update();

            // Update stats
            document.getElementById('total-records').textContent = records.length;

            const uniqueDates = [...new Set(records.map(r => r.date))];
            document.getElementById('days-tracked').textContent = uniqueDates.length;

            const avgFeedings = uniqueDates.length ?
                (records.filter(r => r.type === 'feeding').length / uniqueDates.length).toFixed(1) : 0;
            document.getElementById('avg-feedings').textContent = avgFeedings;

            const avgDiapers = uniqueDates.length ?
                (records.filter(r => r.type === 'wet' || r.type === 'dirty').length / uniqueDates.length).toFixed(1) : 0;
            document.getElementById('avg-diapers').textContent = avgDiapers;
        }

        function exportData() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                records: records
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `babytrack-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            markAsSaved();
            showToast('Data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.records && Array.isArray(data.records)) {
                        records = data.records;
                        records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        // Mark as saved immediately after import (this is the baseline)
                        lastSavedRecordsHash = getRecordsHash();
                        hasUnsavedChanges = false;
                        hideUnsavedWarning();
                        updateDashboard();
                        showToast(`Imported ${records.length} records!`);
                    } else {
                        showToast('Invalid file format', 'error');
                    }
                } catch (error) {
                    showToast('Error reading file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
    </script>
</body>
</html>
